# Isomorphic Git


Since `.lit` already uses [[testing/LightningFS]] for the local filesystem we can easily use https://isomorphic-git.org/docs/en/quickstart to manage versioning...

## Table of Contents

## Initial plan

The initial plan is to just auto commit on all actions, enabling "infinite" undo.

Thereafter that may remain the default but ideally an ergonomic version of the raw git api can be exposed for more advanced users.

*Implementation*





```js ../utils/git-commit-all.js !plugin type=fn id=git-commit-all !collapse
// initially, because it's on every change 
// a commit will mostly be for a single
// file at a time the immediate exception 
// being when a file with output files 
// is edited, in which case the commit 
// includes those files.

export const fn = async () => {
  const now = (new Date()).toISOString()

  const fs = lit.lfs 
  const dir = lit.location.root
  const git = lit.git
  const FILE = 0, WORKDIR = 2, STAGE = 3

  const unstaged = row => {
    return row[WORKDIR] !== row[STAGE]
  }

  // get/list unstaged files
  const status = await git.statusMatrix({ fs,dir})
  const files = status
                .filter( unstaged )
                .map(row => row[FILE])

  // stage everything
  await git.add({fs, dir, filepath: '.'})

  // message 
  const message = `Commit ${lit.location.src}

at ${now} includes the following ${files.length} files:
${files.map(f=> "- " + f).join('\n')}`

  // return message

  // commit
  const sha = await git.commit({fs, dir,
    message,
    author: {
      name: 'dotlitbot',
      email: 'bot@dotlit.org'
    }
  })
  return `Committed ${sha.slice(0,6)} 
${message}`
}
```
```js !plugin id=git type=menu !collapse
export const menu = (ctx, {React, Menu}) => {
  const rc = React.createElement
  const commit = lit.file.data.plugins.fn['git-commit-all']
  const onClick = async ev => alert(await commit())
  return rc( Menu, {
    title:"Git",
    disabled: false,
  }, [rc('span', {onClick}, 'Commit All')])
}
```
```txt updated=1619425559711
Committed d738da 
Auto commit testing/isomorphic_git.lit

at: 2021-04-26T08:25:54.893Z
includes the following 2 files:
- testing/isomorphic_git.lit
- utils/git-commit-all.js
```
## Investigating API


```js
return lit.fs
       .readFile('/.git/HEAD', {
          encoding: 'utf8'
        })
```
```>txt attached=true updated=1621327741152
ref: refs/heads/master

```
```js
return (async () => {
  return await lit.git.init({
    fs: lit.lfs, 
    dir: lit.location.root
  })
})()
```
```>txt attached=true updated=1621327753489
undefined
```
### Status

```js
return (async () => {
  return lit.location.src + " : " + await lit.git.status({
    fs: lit.lfs, 
    dir: lit.location.root, 
    filepath: '.' 
  })
})()
```
```>txt attached=true updated=1621335274603
testing/isomorphic_git.lit : *added
```
```js
return (async () => {
  return await lit.git.statusMatrix({
    fs: lit.lfs, 
    dir: lit.location.root, 
    filepaths: ['testing/']
  })
})()
```
```>txt attached=true updated=1621123831529
[ [ '<', 1, 0, 1 ],
  [ 'articles/ideas_for.lit', 1, 1, 1 ],
  [ 'execute_code_cells.lit', 1, 1, 1 ],
  [ 'index.lit', 1, 1, 1 ],
  [ 'log/2021-05-11.lit', 1, 1, 1 ],
  [ 'meta/settings.lit', 1, 1, 1 ],
  [ 'parser/parser.lit', 1, 1, 1 ],
  [ 'plugin_system.lit', 1, 1, 1 ],
  [ 'renderer/renderer.lit', 1, 1, 1 ],
  [ 'renderer/viewers', 1, 0, 1 ],
  [ 'repls.lit', 1, 1, 1 ],
  [ 'scratch_pad.lit', 1, 1, 1 ],
  [ 'testing/input_buffer.lit', 1, 1, 1 ],
  [ 'testing/isomorphic_git.lit', 1, 1, 1 ],
  [ 'testing/lightningfs.lit', 1, 1, 1 ],
  [ 'testing/log/2021-05-09.lit', 1, 1, 1 ],
  [ 'testing/log/2021-05-11.lit', 1, 1, 1 ],
  [ 'testing/log/2021-05-12.lit', 1, 1, 1 ],
  [ 'testing/log/2021-05-13.lit', 1, 1, 1 ],
  [ 'testing/log/2021-05-15.lit', 1, 1, 1 ],
  [ 'testing/log/2021-w20.lit', 1, 1, 1 ],
  [ 'testing/log/checkforinput.js', 1, 1, 1 ],
  [ 'testing/log/today.js', 1, 1, 1 ],
  [ 'testing/runkit-repl-endpoint.js', 1, 1, 1 ],
  [ 'testing/runkit.lit', 1, 1, 1 ],
  [ 'testing/serviceworker.lit', 1, 1, 1 ],
  [ 'utils/momento.lit', 1, 1, 1 ] ]
```



```js
const fs = lit.lfs 
const dir = lit.location.root
const git = lit.git
const FILE = 0, WORKDIR = 2, STAGE = 3

// list files with unstaged changes
return (async () => {
  const filenames = (await git.statusMatrix({ fs,dir}))
  .filter(row => row[WORKDIR] !== row[STAGE])
  .map(row => row[FILE])
  return filenames
})()
```
```>txt attached=true updated=1621123864584
[ '<', 'renderer/viewers', 'testing/isomorphic_git.lit' ]
```
### Add

```js

const fs = lit.lfs
const dir = lit.location.root

return (async ()=> {
  return await lit.git.add({
    fs,
    dir,
    filepath: '.'
  })
})()
```
```>txt attached=true updated=1621335127754
undefined
```



### Commit

```js

const fs = lit.lfs
const dir = lit.location.root

return (async ()=> {
const now = (new Date()).toISOString()
let sha = await lit.git.commit({
  fs,
  dir,
  message: `Auto commit (${now})`,
  author: {
    name: 'dotlit',
    email: 'bit@dotlit.org'
  }
})

console.log(sha)

})()
```
```>txt attached=true updated=1619388707640
2c1dcf840173cd7c36aa1e5b96bc0922006de579
undefined
```

### Log

```js > text !collapse
const indentLines = str => str.split('\n').map( line => `      ${line}`).join('\n')

return (async ()=> {
  let commits = await lit.git.log({
     fs: lit.lfs, 
     dir: lit.location.root, 
     depth: 10
  })
  return "**Log**\n" + commits.map( x => `1. **\`${x.oid.slice(0,6)}\`**

${indentLines(x.commit.message)}`).join('\n')
})()
```
```>text !collapse attached=true updated=1620129831107
**Log**
1. **`d738da`**

      Auto commit testing/isomorphic_git.lit
      
      at: 2021-04-26T08:25:54.893Z
      includes the following 2 files:
      - testing/isomorphic_git.lit
      - utils/git-commit-all.js
      
1. **`498191`**

      Auto commit testing/isomorphic_git.lit
      
      at: 2021-04-26T08:16:04.689Z
      includes the following 5 files:
      - 404.lit,- execute_code_cells.lit,- testing/.gitignore,- testing/isomorphic_git.lit,- testing/lightningfs.lit
      
1. **`ef8bee`**

      Auto commit testing/isomorphic_git.lit
      
      at: 2021-04-25T23:25:46.517Z
      includes the following 1 files:
      - testing/isomorphic_git.lit
      
1. **`e146ec`**

      Auto commit testing/isomorphic_git.lit
      
      at: (2021-04-25T23:25:04.262Z)
      includes the following 1 files:
      - testing/isomorphic_git.lit
      
1. **`ccc6f8`**

      Auto commit testing/isomorphic_git.lit
      at: (2021-04-25T22:41:55.195Z)
      includes the following tk files...
      
1. **`d6a406`**

      Auto commit (2021-04-25T22:35:27.239Z)
      
1. **`2c1dcf`**

      Auto commit (2021-04-25T22:11:46.433Z)
      
1. **`769349`**

      Auto commit (${now})
      
1. **`74737c`**

      Commit All!!!
      
1. **`a90dc6`**

      Commit All!!!
      
```

### Diff

```js
const {git, lfs} = lit
return [git.walk, git.TREE]
```
```>txt attached=true updated=1620405199415
[ [Function: walk], [Function: TREE] ]
```
```js !collapse
return lit.git
  const commitHash1 = '0c40ed746ebe53cf744d78191d0bbc2941537280'
  const commitHash2 = 'b081f51cd27f54cf58915512006838d4eb67716b'
  const git = lit.git
  return git.walk({
    lit.lfs,
    lit.location.root,
    trees: [git.TREE({ ref: commitHash1 }), git.TREE({ ref: commitHash2 })],
    map: async function(filepath, [A, B]) {
     Â return filepath
    })
  )}
```
```>txt attached=true updated=1620405076140 !error
undefined
```

## Http client

```js

return (async fn =>{
  const http = await import('https://unpkg.com/isomorphic-git/http/web/index.js')
  return lit.git.getRemoteInfo({ http: http.default, url: 'https://github.com/isomorphic-git/isomorphic-git' })
})()

```
```>txt attached=true updated=1621336307318
undefined
```

## Web worker

```>js gitworker.js
/* eslint-env worker */
/* globals LightningFS git MagicPortal GitHttp */
importScripts(
  "https://unpkg.com/@isomorphic-git/lightning-fs",
  "https://unpkg.com/isomorphic-git@beta",
  "https://unpkg.com/isomorphic-git@beta/http/web/index.umd.js",
  "https://unpkg.com/magic-portal"
);

let fs = new LightningFS("fs", { wipe: true });
const portal = new MagicPortal(self);
self.addEventListener("message", ({ data }) => console.log(data));

(async () => {
  let mainThread = await portal.get("mainThread");
  let dir = "/";
  portal.set("workerThread", {
    setDir: async _dir => {
      dir = _dir;
    },
    clone: async args => {
      fs = new LightningFS("fs", { wipe: true });
      return git.clone({
        ...args,
        fs,
        http: GitHttp,
        dir,
        onProgress(evt) {
          mainThread.progress(evt);
        },
        onMessage(msg) {
          mainThread.print(msg);
        },
        onAuth(url) {
          console.log(url);
          return mainThread.fill(url);
        },
        onAuthFailure({ url, auth }) {
          return mainThread.rejected({ url, auth });
        }
      });
    },
    listBranches: args => git.listBranches({ ...args, fs, dir }),
    listFiles: args => git.listFiles({ ...args, fs, dir }),
    log: args => git.log({ ...args, fs, dir })
  });
})();
```

```>html viewer=iframe
<div>
  <input
    id="repository"
    type="text"
    style="width: 50em"
    title="Tip: enter a private repo URL to see the credentialManager plugin prompt for a password."
  />
  <button type="button" id="cloneButton">Clone</button>
</div>
<div>
  <progress id="progress" value="0"></progress>
  <span id="progress-txt" style="font-family: monospace;"></span>
</div>
<output id="log" style="white-space: pre; font-family: monospace;"></output>

<script src="https://unpkg.com/magic-portal"></script>
<script>
  const $ = id => document.getElementById(id);

  let worker = new Worker("./worker.js");
  const portal = new MagicPortal(worker);
  worker.addEventListener("message", ({ data }) => console.log(data));

  const mainThread = {
    async print(message) {
      let text = $("log").textContent;
      if (message.endsWith("\r")) {
        // overwrite last line
        text = text.trim().replace(/.+$/, "");
      }
      text += message + "\n";
      $("log").textContent = text;
    },
    async progress(evt) {
      $("progress-txt").textContent = evt.phase;
      $("progress").value = evt.total ? evt.loaded / evt.total : 0.5;
      return;
    },
    async fill(url) {
      let username = window.prompt("Username:");
      let password = window.prompt("Password:");
      return { username, password };
    },
    async rejected({ url, auth }) {
      window.alert("Authentication rejected");
      return;
    }
  };
  portal.set("mainThread", mainThread, {
    void: ["print", "progress", "rejected"]
  });

```





