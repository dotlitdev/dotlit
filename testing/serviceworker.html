<html data-reactroot=""><head><title>testing/serviceworker</title><meta name="litsrc" value="testing/serviceworker.lit"/><meta name="litroot" value="/"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/railscasts.css"/><link rel="stylesheet" href="/style.css"/></head><body><div id="lit-app"><div id="lit-header"><menu class="horizontal open has-children"><li class="MenuTitle"><a href="/">Home</a></li><li class="MenuItems"><menu class="has-children"><li class="MenuTitle">File</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Cell</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Section</li></menu><menu class="has-children"><li class="MenuTitle">Help</li></menu><menu class="has-children right"><li class="MenuTitle"><span class="led led-grey"></span></li></menu></li></menu><div class="lit-messages"></div></div><div id="content"><section depth="1" class="" startpos="1:1-0" endpos="11:55-418"><cell startpos="1:1-0" endpos="1:24-23"><div class="cell-content"><h1 id="testingserviceworker">testing/serviceworker</h1></div></cell><section depth="2" class="" startpos="3:1-25" endpos="11:55-418"><cell startpos="3:1-25" endpos="11:55-418"><div class="cell-content"><h2 id="references">References</h2><ul>
<li><a href="https://ponyfoo.com/articles/serviceworker-revolution">https://ponyfoo.com/articles/serviceworker-revolution<span class="linkIcon">↗</span></a></li>
<li><a href="https://github.com/homam/service-workers-example">https://github.com/homam/service-workers-example<span class="linkIcon">↗</span></a></li>
<li>Communication<!-- -->
<ul>
<li><del><a href="https://stackoverflow.com/a/66784901/371040">broadcast channels<span class="linkIcon">↗</span></a></del> not available in safari, desktop or iOS</li>
</ul>
</li>
<li>Initial source, from: <a href="https://googlechrome.github.io/samples/service-worker/basic/">https://googlechrome.github.io/samples/service-worker/basic/<span class="linkIcon">↗</span></a></li>
</ul><p>See <a href="testing/web_workers.html?file=testing/web_workers.lit" title="testing/Web Workers" wikilink="true">testing/Web Workers</a> for related investigation.</p></div></cell></section></section>
<section depth="2" class="" startpos="13:1-420" endpos="81:4-3153"><cell startpos="13:1-420" endpos="13:15-434"><div class="cell-content"><h2 id="exploration">Exploration</h2></div></cell><cell startpos="14:1-435" endpos="19:4-512" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return navigator
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">23 minutes ago</span></span></span><output><pre><code class="txt">{}
</code></pre></output></codecell></div></cell><cell startpos="21:1-514" endpos="28:4-628" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">if (&#x27;serviceWorker&#x27; in navigator) {
  return true
}
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">4 days ago</span></span></span><output><pre><code class="txt">true
</code></pre></output></codecell></div></cell><cell startpos="31:1-631" endpos="38:4-784" class="code"><div class="cell-content"><codecell class="tag-register lang-js local"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#d6dc2e" class="tag">register</span></span><pre><code class="js">return navigator
          .serviceWorker
          .register(&#x27;/serviceworker.js&#x27;)
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">41 seconds ago</span></span></span><output><pre><code class="txt">{}
</code></pre></output></codecell></div></cell><cell startpos="40:1-786" endpos="47:4-993" class="code"><div class="cell-content"><codecell class="tag-status lang-js local"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#cacdcf" class="tag">status</span></span><pre><code class="js">return navigator.serviceWorker.controller
         ? &quot;Service worker active.&quot;
         : &quot;Refresh to activate worker.&quot;
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">46 seconds ago</span></span></span><output><pre><code class="txt">Service worker active.
</code></pre></output></codecell></div></cell><cell startpos="49:1-995" endpos="57:4-1223" class="code"><div class="cell-content"><codecell class="tag-unregister lang-js local"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#31d494" class="tag">unregister</span></span><pre><code class="js">navigator.serviceWorker.getRegistrations().then(function(registrations) {
 for(let registration of registrations) {
  registration.unregister()
} })
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">3 days ago</span></span></span><output><pre><code class="txt">undefined
</code></pre></output></codecell></div></cell><cell startpos="58:1-1224" endpos="66:4-1369" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async fn =&gt; {
  const resp = await fetch(&#x27;/none&#x27;)
  return resp.status
})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">4 days ago</span></span></span><output><pre><code class="txt">404
</code></pre></output></codecell></div></cell><cell startpos="67:1-1370" endpos="72:4-1471" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (new Response(&#x27;hello&#x27;)).text()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">4 days ago</span></span></span><output><pre><code class="txt">hello
</code></pre></output></codecell></div></cell><cell startpos="73:1-1472" endpos="81:4-3153" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async fn =&gt; {
  const resp = await fetch(&#x27;/swversion&#x27;)
  return resp.status + &quot; : &quot; + (await resp.text())
})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">58 seconds ago</span></span></span><output><pre><code class="txt">404 : &lt;html data-reactroot=&quot;&quot;&gt;&lt;head&gt;&lt;title&gt;Not yet found&lt;/title&gt;&lt;meta name=&quot;litsrc&quot; value=&quot;404.lit&quot;/&gt;&lt;meta name=&quot;litroot&quot; value=&quot;/&quot;/&gt;&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0&quot;/&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;https://highlightjs.org/static/demo/styles/railscasts.css&quot;/&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;/style.css&quot;/&gt;&lt;/head&gt;&lt;body&gt;&lt;div id=&quot;lit-app&quot;&gt;&lt;div id=&quot;lit-header&quot;&gt;&lt;menu class=&quot;horizontal open has-children&quot;&gt;&lt;li class=&quot;MenuTitle&quot;&gt;&lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;&lt;/li&gt;&lt;li class=&quot;MenuItems&quot;&gt;&lt;menu class=&quot;has-children&quot;&gt;&lt;li class=&quot;MenuTitle&quot;&gt;File&lt;/li&gt;&lt;/menu&gt;&lt;menu class=&quot;has-children&quot; disabled=&quot;&quot;&gt;&lt;li class=&quot;MenuTitle&quot;&gt;Cell&lt;/li&gt;&lt;/menu&gt;&lt;menu class=&quot;has-children&quot; disabled=&quot;&quot;&gt;&lt;li class=&quot;MenuTitle&quot;&gt;Section&lt;/li&gt;&lt;/menu&gt;&lt;menu class=&quot;has-children&quot;&gt;&lt;li class=&quot;MenuTitle&quot;&gt;Help&lt;/li&gt;&lt;/menu&gt;&lt;menu class=&quot;has-children right&quot;&gt;&lt;li class=&quot;MenuTitle&quot;&gt;&lt;span class=&quot;led led-grey&quot;&gt;&lt;/span&gt;&lt;/li&gt;&lt;/menu&gt;&lt;/li&gt;&lt;/menu&gt;&lt;div class=&quot;lit-messages&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div id=&quot;content&quot;&gt;&lt;section depth=&quot;1&quot; class=&quot;&quot; startpos=&quot;1:1-0&quot; endpos=&quot;3:55-73&quot;&gt;&lt;cell startpos=&quot;1:1-0&quot; endpos=&quot;3:55-73&quot;&gt;&lt;div class=&quot;cell-content&quot;&gt;&lt;h1 id=&quot;not-yet-found&quot;&gt;Not &lt;em&gt;yet&lt;/em&gt; found&lt;/h1&gt;&lt;p&gt;The file was not found, edit this page to change that.&lt;/p&gt;&lt;/div&gt;&lt;/cell&gt;&lt;/section&gt;&lt;/div&gt;&lt;/div&gt;&lt;div id=&quot;backlinks&quot;&gt;&lt;h4&gt;Backlinks (1)&lt;/h4&gt;&lt;ol&gt;&lt;li&gt;&lt;a title=&quot;.lit&quot; href=&quot;/index.html&quot;&gt;.lit&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;&lt;script src=&quot;//cdn.jsdelivr.net/npm/eruda&quot;&gt;&lt;/script&gt;&lt;script&gt;eruda.init();&lt;/script&gt;&lt;script src=&quot;/web.bundle.js&quot;&gt;&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre></output></codecell></div></cell></section>
<section depth="2" class="" startpos="83:1-3155" endpos="156:4-5517"><cell startpos="83:1-3155" endpos="83:18-3172"><div class="cell-content"><h2 id="implementation">Implementation</h2></div></cell><cell startpos="84:1-3173" endpos="156:4-5517" class="code output"><div class="cell-content"><codecell class="dir-collapse tag-implementation lang-js local collapsed output"><span class="meta"><span class="lang">js</span><span class="filename">../serviceworker.js</span><span style="color:white;background-color:#6455ab" class="tag">implementation</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span></span><output><pre><code class="js">
// gross hack around one of @codemirror/view bugs
let document = { documentElement: { style: {} } }

importScripts(&#x27;web.bundle.js&#x27;)
postMessage(&quot;dotlit: &quot; + typeof dotlit)

const PRECACHE = Date.now() // no-cache &#x27;precache-v1&#x27;;
const RUNTIME = &#x27;runtime&#x27;;

// A list of local resources we always want to be cached.
const PRECACHE_URLS = [
  //&#x27;index.html&#x27;,
  //&#x27;./&#x27;, // Alias for index.html
  //&#x27;styles.css&#x27;,
  //&#x27;../../styles/main.css&#x27;,
  //&#x27;demo.js&#x27;
];

const getMockResponse = args =&gt; new Response(&#x27;sv:version:0.0.1&#x27;)

// The install handler takes care of precaching the resources we always need.
self.addEventListener(&#x27;install&#x27;, event =&gt; {
  event.waitUntil(
    caches.open(PRECACHE)
      .then(cache =&gt; cache.addAll(PRECACHE_URLS))
      .then(self.skipWaiting())
  );
});

// The activate handler takes care of cleaning up old caches.
self.addEventListener(&#x27;activate&#x27;, event =&gt; {
  const currentCaches = [PRECACHE, RUNTIME];
  event.waitUntil(
    caches.keys().then(cacheNames =&gt; {
      return cacheNames.filter(cacheName =&gt; !currentCaches.includes(cacheName));
    }).then(cachesToDelete =&gt; {
      return Promise.all(cachesToDelete.map(cacheToDelete =&gt; {
        return caches.delete(cacheToDelete);
      }));
    }).then(() =&gt; self.clients.claim())
  );
});

// The fetch handler serves responses for same-origin resources from a cache.
// If no response is found, it populates the runtime cache with the response
// from the network before returning it to the page.
self.addEventListener(&#x27;fetch&#x27;, event =&gt; {
  // Skip cross-origin requests, like those for Google Analytics. And add mock response
  if (event.request.url.startsWith(self.location.origin)) {
    if (event.request.url.endsWith(&#x27;/swversion&#x27;)) {
       event.respondWith(getMockResponse())
    }
    else event.respondWith(
      caches.match(event.request).then(cachedResponse =&gt; {
        if (false &amp;&amp; cachedResponse) {
          return cachedResponse;
        }

        return caches.open(RUNTIME).then(cache =&gt; {
          return fetch(event.request).then(response =&gt; {
            // Put a copy of the response in the runtime cache.
            return cache.put(event.request, response.clone()).then(() =&gt; {
              return response;
            });
          });
        });
      })
    );
  }
});
</code></pre></output></codecell></div></cell></section></div></div><div id="backlinks"><h4>Backlinks (1)</h4><ol><li><a title=".lit" href="/index.html">.lit</a></li></ol></div><script src="//cdn.jsdelivr.net/npm/eruda"></script><script>eruda.init();</script><script src="/web.bundle.js"></script></body></html>