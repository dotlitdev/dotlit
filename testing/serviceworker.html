<html data-reactroot=""><head><title>Service Worker</title><meta name="litsrc" value="/testing/serviceworker.lit"/><meta name="litroot" value="/"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><meta name="apple-mobile-web-app-capable" content="yes"/><link rel="apple-touch-icon" href="/assets/lit-logo.png"/><link rel="icon" href="/assets/lit-logo.png"/><link rel="stylesheet" href="/style.css"/></head><body><div id="lit-app"><div id="lit-header"><menu class="horizontal open has-children"><li class="MenuTitle"><a href="/">Home</a></li><li class="MenuItems"><menu class="has-children" disabled=""><li class="MenuTitle">File</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Cell</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Section</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Help</li></menu><menu class="has-children right"><li class="MenuTitle"><span class="led led-grey"></span><span class="led led-grey"></span><span class="led led-grey"></span></li></menu></li></menu></div><style>body {
  --bg: white;
  --bg-secondary-color: #efefef;
    
  --text-color: black;
  --text-secondary-color: grey;
  --text-primary-color: #9999f7;
  --text-highlight-bg: yellow;
  --text-highlight-color: black;

  --divider-subtle: #efefef;
  --medium-space: 0.4em;
  --code-bg-color: black;
  --code-text-color: white;
  --box-bg-opacity: 0.05;
}</style><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.0/build/styles/sunburst.min.css"/><div id="content"><section id="service-worker" depth="1" class="" startpos="1:1-0" endpos="10:21-154"><div startpos="1:1-0" endpos="1:17-16" class="cell"><div class="cell-content"><h1>Service Worker</h1></div></div><div startpos="3:1-18" endpos="8:4-132" class="code   cell"><div class="cell-content"><div class="dir-collapse lang-js local collapsed codecell"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span class="attribute attr-exec" style="color:black;background-color:#02fb89">exec=onload</span></span><pre><code class="js">return fetch(&quot;--sw&quot;)
  .catch((err) =&gt; err.message)
  .then((res) =&gt; res.status);

</code></pre></div></div></div><section id="table-of-contents" depth="2" class="" startpos="10:1-134" endpos="10:21-154"><div startpos="10:1-134" endpos="10:21-154" class="cell"><div class="cell-content"><h2>Table of Contents</h2><ul>
<li><a class="fragment" href="#references">References<span class="linkIcon">§</span></a></li>
<li><a class="fragment" href="#exploration">Exploration<span class="linkIcon">§</span></a></li>
<li><a class="fragment" href="#implementation">Implementation<span class="linkIcon">§</span></a></li>
<li><a class="fragment" href="#to-do">To do<span class="linkIcon">§</span></a></li>
</ul></div></div></section></section>
<section id="references" depth="2" class="" startpos="12:1-156" endpos="24:55-800"><div startpos="12:1-156" endpos="24:55-800" class="cell"><div class="cell-content"><h2>References</h2><ul>
<li><a class="external" href="https://ponyfoo.com/articles/serviceworker-revolution" filepath="/testing/serviceworker.lit" root="" data="[object Object]">https://ponyfoo.com/articles/serviceworker-revolution<span class="linkIcon">↗</span></a></li>
<li><a class="external" href="https://github.com/homam/service-workers-example" filepath="/testing/serviceworker.lit" root="" data="[object Object]">https://github.com/homam/service-workers-example<span class="linkIcon">↗</span></a></li>
<li>Communication<!-- -->
<ul>
<li><del><a class="external" href="https://stackoverflow.com/a/66784901/371040" filepath="/testing/serviceworker.lit" root="" data="[object Object]">broadcast channels<span class="linkIcon">↗</span></a></del> not available in safari, desktop or iOS</li>
</ul>
</li>
<li>Initial source, from: <a class="external" href="https://googlechrome.github.io/samples/service-worker/basic/" filepath="/testing/serviceworker.lit" root="" data="[object Object]">https://googlechrome.github.io/samples/service-worker/basic/<span class="linkIcon">↗</span></a></li>
<li><a class="external" href="https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/respondWith" filepath="/testing/serviceworker.lit" root="" data="[object Object]">https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/respondWith<span class="linkIcon">↗</span></a></li>
<li><a class="external" href="https://stackoverflow.com/questions/44424709/passing-state-info-into-a-service-worker-before-install" filepath="/testing/serviceworker.lit" root="" data="[object Object]">https://stackoverflow.com/questions/44424709/passing-state-info-into-a-service-worker-before-install<span class="linkIcon">↗</span></a></li>
<li><a class="external" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch" filepath="/testing/serviceworker.lit" root="" data="[object Object]">https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch<span class="linkIcon">↗</span></a></li>
</ul><p>See <a class="exists local" href="web_workers.html" title="testing/Web Workers" wikilink="true" filepath="/testing/serviceworker.lit" root="" data="[object Object]">testing/Web Workers</a> for related investigation.</p></div></div></section>
<section id="exploration" depth="2" class="" startpos="26:1-802" endpos="131:4-2879"><div startpos="26:1-802" endpos="26:15-816" class="cell"><div class="cell-content"><h2>Exploration</h2></div></div><div startpos="27:1-817" endpos="32:4-894" class="code   cell"><div class="cell-content"><div class="lang-js local codecell"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return navigator
</code></pre></div><div class="lang-txt local codecell output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">58.6w ago</span></span></span><output><pre><code class="txt">{}
</code></pre></output></div></div></div><div startpos="34:1-896" endpos="41:4-1010" class="code   cell"><div class="cell-content"><div class="lang-js local codecell"><span class="meta"><span class="lang">js</span></span><pre><code class="js">if (&#x27;serviceWorker&#x27; in navigator) {
  return true
}
</code></pre></div><div class="lang-txt local codecell output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">59.2w ago</span></span></span><output><pre><code class="txt">true
</code></pre></output></div></div></div><div startpos="44:1-1013" endpos="51:4-1190" class="code   cell"><div class="cell-content"><div class="tag-register lang-js local codecell"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#d6dc2e" class="tag">register</span></span><pre><code class="js">return navigator
          .serviceWorker
          .register(&#x27;/serviceworker.js?root=&#x27;+lit.location.root)
</code></pre></div><div class="lang-txt local codecell output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">50.3w ago</span></span></span><output><pre><code class="txt">{}
</code></pre></output></div></div></div><div startpos="53:1-1192" endpos="53:60-1251" class="cell"><div class="cell-content"><ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->To do, handle register for non-root hosted notebooks.</li>
</ul></div></div><div startpos="55:1-1253" endpos="59:4-1400" class="code   cell"><div class="cell-content"><div class="tag-status lang-js local codecell"><span class="meta"><span class="lang">js</span><span class="attribute attr-exec" style="color:black;background-color:#02fb89">exec=onload</span><span style="color:black;background-color:#cacdcf" class="tag">status</span></span><pre><code class="js">return navigator.serviceWorker.controller
         ? &quot;Service worker active.&quot;
         : &quot;Service worker Not active.&quot;
</code></pre></div></div></div><div startpos="61:1-1402" endpos="76:4-1791" class="code   cell"><div class="cell-content"><div class="tag-unregister lang-js local codecell"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#31d494" class="tag">unregister</span></span><pre><code class="js">return (async fn =&gt; {
  const regs = await navigator
                     .serviceWorker
                     .getRegistrations()
  for(let registration of regs) {
    console.log(registration)
    registration.unregister()
  }
  return `Unregistered ${regs.length} regisration(s)`
})()
</code></pre></div><div class="lang-txt local codecell output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">1w ago</span></span></span><output><pre><code class="txt">{}
Unregistered 1 regisration(s)
</code></pre></output></div></div></div><div startpos="77:1-1792" endpos="83:4-1911" class="code   cell"><div class="cell-content"><div class="lang-js local codecell"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return fetch(&#x27;/none&#x27;)
       .then( resp =&gt; resp.status )
</code></pre></div><div class="lang-txt local codecell output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">58.4w ago</span></span></span><output><pre><code class="txt">404
</code></pre></output></div></div></div><div startpos="84:1-1912" endpos="90:4-2038" class="code   cell"><div class="cell-content"><div class="lang-js local codecell"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return fetch(&#x27;/manifest.json&#x27;)
       .then(resp =&gt; resp.status)
</code></pre></div><div class="lang-txt local codecell output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">58.6w ago</span></span></span><output><pre><code class="txt">200
</code></pre></output></div></div></div><div startpos="91:1-2039" endpos="96:4-2140" class="code   cell"><div class="cell-content"><div class="lang-js local codecell"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (new Response(&#x27;hello&#x27;)).text()
</code></pre></div><div class="lang-txt local codecell output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">59.2w ago</span></span></span><output><pre><code class="txt">hello
</code></pre></output></div></div></div><div startpos="98:1-2142" endpos="98:199-2340" class="cell"><div class="cell-content"><p><del>As of now, the service worker doesn&#x27;t cache anything and just passes through to the network as normal.</del> Except if the <code>request.url</code> ends with <code>--sw</code> in which case it returns a mock/info response.</p></div></div><div startpos="99:1-2341" endpos="126:4-2838" class="code   cell"><div class="cell-content"><div class="lang-js local codecell"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return fetch(&#x27;/--sw&#x27;)
       .then(resp =&gt; resp.text()
                          .then( text =&gt; `${resp.status}\n${text}`)
       )
</code></pre></div><div class="lang-txt local codecell output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">52.3w ago</span></span></span><output><pre><code class="txt">200
{
  &quot;version&quot;: &quot;0.2.17&quot;,
  &quot;dotlit&quot;: &quot;object&quot;,
  &quot;root&quot;: &quot;/&quot;,
  &quot;enableCache&quot;: false,
  &quot;count&quot;: 11,
  &quot;filepath&quot;: &quot;/&quot;,
  &quot;stat&quot;: {
    &quot;type&quot;: &quot;dir&quot;,
    &quot;mode&quot;: 511,
    &quot;size&quot;: 0,
    &quot;ino&quot;: 0,
    &quot;mtimeMs&quot;: 1621892330665,
    &quot;ctimeMs&quot;: 1621892330665,
    &quot;uid&quot;: 1,
    &quot;gid&quot;: 1,
    &quot;dev&quot;: 1
  }
}
</code></pre></output></div></div></div><div startpos="129:1-2841" endpos="131:4-2879" class="code   cell"><div class="cell-content"><div class="lang-text local codecell"><span class="meta"><span class="lang">text</span><span class="source">&lt; ./getserviceworker--sw</span></span><pre><code class="text"></code></pre></div></div></div></section>
<section id="implementation" depth="2" class="" startpos="133:1-2881" endpos="137:4-2958"><div startpos="133:1-2881" endpos="133:18-2898" class="cell"><div class="cell-content"><h2>Implementation</h2></div></div><div startpos="135:1-2900" endpos="137:4-2958" class="code   cell"><div class="cell-content"><div class="dir-collapse tag-implementation lang-js local collapsed codecell"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span style="color:white;background-color:#6455ab" class="tag">implementation</span><span class="source">&lt; ../serviceworker.js</span></span><pre><code class="js">// gross hack around one of @codemirror/view bugs
let document = { documentElement: { style: {} } };

importScripts(&quot;web.bundle.js&quot;);

const state = {
  version: &quot;0.3.1&quot;,
  dotlit: typeof dotlit,
  root: &quot;&quot;,
  enableCache: false,
  count: 0,
};

const PRECACHE = &quot;precache-v1&quot;;
const RUNTIME = &quot;runtime&quot;;
const CACHE_FIRST = &#x27;cachefirst-v1&#x27;;

const CACHE_FIRST_DOMAINS = [
  &#x27;https://cdn.skypack.dev&#x27;,
  &#x27;http://cdn.jsdelivr.net&#x27;,
  &#x27;https://cdn.jsdelivr.net&#x27;,
  &#x27;https://unpkg.com/&#x27;
]

// A list of local resources we always want to be cached.
const PRECACHE_URLS = [
  //&#x27;index.html&#x27;,
  //&#x27;./&#x27;, // Alias for index.html
  //&#x27;styles.css&#x27;,
  //&#x27;../../styles/main.css&#x27;,
  //&#x27;demo.js&#x27;
];

const getMockResponse = async (event) =&gt; {
  state.count += 1;
  try {
    if (typeof dotlit !== &quot;undefined&quot;) {
      const filepath = event.request.url
        .slice(dotlit.lit.location.base.length - 1, -4)
        .slice();
      const stat = await dotlit.lit.fs.stat(filepath);
      const status = {
        ...state,
        filepath,
        stat,
        method: event.request.method,
      };
      return new Response(JSON.stringify(status, null, 2), {
        headers: { meta: state.version },
      });
    }
  } catch (err) {
    const status = {
      ...state,
      url: event.request.url,
      err: err.message,
    };
    return new Response(JSON.stringify(status, null, 2));
  }
};

const localFile = async (event) =&gt; {
  if (typeof dotlit !== &quot;undefined&quot;) {
    const filepath = event.request.url
      .slice(dotlit.lit.location.base.length - 1)
      .slice();
    await dotlit.lit.fs.stat(filepath);
    let jsFile;
    const content = await dotlit.lit.fs.readFile(filepath, { localOnly: true });
    state.count += 1;
    return new Response(content, {
      headers: {
        server: `dotlit.org/sw@${state.version}`,
        &quot;Content-Type&quot;:
          dotlit.lit.utils.mime.contentType(
            dotlit.lit.utils.path.extname(filepath)
          ) || &quot;text/plain&quot;,
      },
    });
  } else throw new Error(&quot;dotlit module not loaded.&quot;);
};

// The install handler takes care of precaching the resources we always need.
self.addEventListener(&quot;install&quot;, (event) =&gt; {
  state.root = new URL(location).searchParams.get(&quot;root&quot;);
  event.waitUntil(
    caches
      .open(PRECACHE)
      .then((cache) =&gt; cache.addAll(PRECACHE_URLS))
      .then(self.skipWaiting())
  );
});

// The activate handler takes care of cleaning up old caches.
self.addEventListener(&quot;activate&quot;, (event) =&gt; {
  const currentCaches = [PRECACHE, RUNTIME, CACHE_FIRST];
  event.waitUntil(
    caches
      .keys()
      .then((cacheNames) =&gt; {
        return cacheNames.filter(
          (cacheName) =&gt; !currentCaches.includes(cacheName)
        );
      })
      .then((cachesToDelete) =&gt; {
        return Promise.all(
          cachesToDelete.map((cacheToDelete) =&gt; {
            return caches.delete(cacheToDelete);
          })
        );
      })
      .then(() =&gt; self.clients.claim())
  );
});


const isCacheFirstOrigin = (url) =&gt; {
  for (const domain of CACHE_FIRST_DOMAINS) {
    if (url.startsWith(domain)) return true
  }  
}

const isSameOrigin = (url) =&gt; {
  return url.startsWith(self.location.origin)
}

const fetchAndAddToCache = (event, cacheBucket = RUNTIME) =&gt; {
  return caches.match(event.request).then((cachedResponse) =&gt; {
    return caches.open(cacheBucket).then((cache) =&gt; {
      return fetch(event.request)
        .then((response) =&gt; {
          // Put a copy of the response in the runtime cache.
          return cache
            .put(event.request, response.clone())
            .then(() =&gt; {
              return response;
            });
        })
        .catch((err) =&gt; {
          if (!cachedResponse) throw err;
          return cachedResponse;
        });
    });
  });
  
}

const cacheFirstHandler = (event) =&gt; {
  console.log(&quot;Cache first origin request &quot;, event.request.url)
  return caches.match(event.request).then((cachedResponse) =&gt; {
    if (cachedResponse) {
      console.log(&#x27;Serving from cache.&#x27;)
      return cachedResponse
    } else return fetchAndAddToCache(event, CACHE_FIRST)
  })
}

// The fetch handler serves responses for same-origin resources from a cache.
// If no response is found, it populates the runtime cache with the response
// from the network before returning it to the page.
self.addEventListener(&quot;fetch&quot;, (event) =&gt; {

  const url = event.request.url
  const method = event.request.method

  // if (method.toLowerCase() !== &#x27;get&#x27;) return

  // is the request is for a CacheFirst origin
  if (isCacheFirstOrigin(url)) {
    console.log(&quot;CACHE FIRST REQUEST&quot;, url)
    event.respondWith( cacheFirstHandler(event) )

  // if the requset if for the same origin
  } else if (isSameOrigin(url)) {

    // if its a mock requests
    if (event.request.url.endsWith(&quot;--sw&quot;)) {
      console.log(&quot;Mock/Info request&quot;);
      event.respondWith(getMockResponse(event));
    
    // check local filessystem first
    } else {
      event.respondWith(
        localFile(event)
          .then((file) =&gt; {
            console.log(&quot;Responding with&quot;, file);
            return file;
          })
          .catch((err) =&gt; {
            console.log(&quot;Failed local file check, reverting to network&quot;, err);
            return fetchAndAddToCache(event)
          })
      );
    }

  // for everything else fetch and add to cache for when offline
  } else {
    event.respondWith( fetchAndAddToCache(event) )
  }
    
});

</code></pre></div></div></div></section>
<section id="to-do" depth="2" class="" startpos="139:1-2960" endpos="142:80-3132"><div startpos="139:1-2960" endpos="142:80-3132" class="cell"><div class="cell-content"><h2>To do</h2><ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->Serve from cache first for specified domains (skypack, unpkg, jsdeliver etc)</li>
<li class="task-list-item"><input type="checkbox" checked="" disabled=""/> <!-- -->Add responses not on host domain to <code>RUNTIME</code> cache for offline usage...?</li>
</ul></div></div></section></div></div><div id="backlinks"><h4>Backlinks (1)</h4><ol><li><a title="🔬 Tests, experiments and investigations" href="/testing/index.html">🔬 Tests, experiments and investigations</a></li></ol></div><script src="//cdn.jsdelivr.net/npm/eruda"></script><script>eruda.init();</script><script async="" src="/web.bundle.js"></script></body></html>