<html data-reactroot=""><head><title>Compact Manifest</title><meta name="litsrc" value="/testing/compact_manifest.lit"/><meta name="litroot" value="/"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><link rel="stylesheet" href="/style.css"/></head><body><div id="lit-app"><div id="lit-header"><menu class="horizontal open has-children"><li class="MenuTitle"><a href="/">Home</a></li><li class="MenuItems"><menu class="has-children"><li class="MenuTitle">File</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Cell</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Section</li></menu><menu class="has-children"><li class="MenuTitle">Help</li></menu><menu class="has-children right"><li class="MenuTitle"><span class="led led-grey"></span></li></menu></li></menu><div class="lit-messages"></div></div><div id="content"><section depth="1" class="" startpos="1:1-0" endpos="53:4-7529"><cell startpos="1:1-0" endpos="3:78-97"><div class="cell-content"><h1 id="compact-manifest">Compact Manifest</h1><p>Reducing the serialised size of a manifest of all files in a <code>.lit</code> notebook.</p></div></cell><section depth="2" class="" startpos="5:1-99" endpos="53:4-7529"><cell startpos="5:1-99" endpos="7:84-196"><div class="cell-content"><h2 id="exploring">Exploring</h2><p>Trying out <a class="external" href="https://github.com/sidvishnoi/compact-prefix-tree" filepath="/testing/compact_manifest.lit" root="" data="[object Object]" canonical="https://github.com/sidvishnoi/compact-prefix-tree">compact-prefix-tree<span class="linkIcon">â†—</span></a></p></div></cell><cell startpos="8:1-197" endpos="27:4-6929" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async fn =&gt; {
  const {CompactPrefixTree} = await import(&#x27;https://cdn.skypack.dev/compact-prefix-tree&#x27;)

  const manifest = await fetch(&#x27;/manifest.json&#x27;).then(res =&gt; res.json())
  const keys = manifest.nodes.map(n=&gt;n.id)
  const trie = new CompactPrefixTree(keys)

  const before = JSON.stringify(manifest.nodes.reduce((m,n)=&gt;{m[n.id] = null; return m }, {}))
  //console.log(before)
  const after = JSON.stringify(trie.T)
  // console.log(trie.T)
  await lit.fs.writeFile(&#x27;/testing/compactManifest1.json&#x27;, after, &#x27;utf8&#x27;)
  return `${before.length}-&gt;${after.length}. A ${100-(after.length/before.length*100)}% reduction in size.`
})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">2m ago</span></span></span><output><pre><code class="txt">{&quot;/404.lit&quot;:null,&quot;/an_acceptable_development_evironment.lit&quot;:null,&quot;/articles/ideas_for.lit&quot;:null,&quot;/cli/cli.lit&quot;:null,&quot;/client/client.lit&quot;:null,&quot;/components/components.lit&quot;:null,&quot;/config.lit&quot;:null,&quot;/digital_gardens.lit&quot;:null,&quot;/divergence_from_markdown.lit&quot;:null,&quot;/dummy/ðŸ”¥.lit&quot;:null,&quot;/execute_code_cells.lit&quot;:null,&quot;/filesystem/index.lit&quot;:null,&quot;/index.lit&quot;:null,&quot;/literate_programming.lit&quot;:null,&quot;/meta.lit&quot;:null,&quot;/meta/files_and_links.lit&quot;:null,&quot;/meta/github_workflows.lit&quot;:null,&quot;/meta/styling_and_themes.lit&quot;:null,&quot;/meta/the_bazaar.lit&quot;:null,&quot;/parser/parser.lit&quot;:null,&quot;/persist_to_github.lit&quot;:null,&quot;/plugin_system.lit&quot;:null,&quot;/plugins/viewers/md/admonitions.lit&quot;:null,&quot;/plugins/viewers/plantuml/plantuml.lit&quot;:null,&quot;/prismjs_and_a_simple_editor.lit&quot;:null,&quot;/renderer/renderer.lit&quot;:null,&quot;/repl/index.lit&quot;:null,&quot;/repls.lit&quot;:null,&quot;/scratch_pad.lit&quot;:null,&quot;/seedling.lit&quot;:null,&quot;/taking_notes.lit&quot;:null,&quot;/testing/autoformatting_cell_source.lit&quot;:null,&quot;/testing/compact_manifest.lit&quot;:null,&quot;/testing/cors_proxy.lit&quot;:null,&quot;/testing/esm_viewer_repl.lit&quot;:null,&quot;/testing/fuzzy_text_search.lit&quot;:null,&quot;/testing/importing_js_modules.lit&quot;:null,&quot;/testing/index.lit&quot;:null,&quot;/testing/input_buffer.lit&quot;:null,&quot;/testing/isomorphic_git.lit&quot;:null,&quot;/testing/lightningfs.lit&quot;:null,&quot;/testing/links.lit&quot;:null,&quot;/testing/local_remote_files.lit&quot;:null,&quot;/testing/log/2021-05-09.lit&quot;:null,&quot;/testing/log/2021-05-11.lit&quot;:null,&quot;/testing/log/2021-05-12.lit&quot;:null,&quot;/testing/log/2021-05-13.lit&quot;:null,&quot;/testing/log/2021-05-15.lit&quot;:null,&quot;/testing/log/2021-05-16.lit&quot;:null,&quot;/testing/log/2021-05-17.lit&quot;:null,&quot;/testing/log/2021-05-18.lit&quot;:null,&quot;/testing/log/2021-05-19.lit&quot;:null,&quot;/testing/log/2021-05-20.lit&quot;:null,&quot;/testing/log/2021-05-21.lit&quot;:null,&quot;/testing/log/2021-05-23.lit&quot;:null,&quot;/testing/log/2021-05-25.lit&quot;:null,&quot;/testing/log/2021-05-27.lit&quot;:null,&quot;/testing/log/2021-05-29.lit&quot;:null,&quot;/testing/log/2021-05-30.lit&quot;:null,&quot;/testing/log/2021-05.lit&quot;:null,&quot;/testing/log/2021-06-01.lit&quot;:null,&quot;/testing/log/2021-06-02.lit&quot;:null,&quot;/testing/log/2021-06-04.lit&quot;:null,&quot;/testing/log/2021-06-05.lit&quot;:null,&quot;/testing/log/2021-w20.lit&quot;:null,&quot;/testing/log/2021-w21.lit&quot;:null,&quot;/testing/log/2021.lit&quot;:null,&quot;/testing/log/day.lit&quot;:null,&quot;/testing/paths.lit&quot;:null,&quot;/testing/private_files.lit&quot;:null,&quot;/testing/runkit.lit&quot;:null,&quot;/testing/selection.lit&quot;:null,&quot;/testing/serviceworker.lit&quot;:null,&quot;/testing/web_workers.lit&quot;:null,&quot;/throwaway/codevaluebug.lit&quot;:null,&quot;/time_to_pudding.lit&quot;:null,&quot;/utils/index.lit&quot;:null,&quot;/utils/momento.lit&quot;:null,&quot;/viewers.lit&quot;:null,&quot;/wiki-links.lit&quot;:null,&quot;client/index.jsx&quot;:null,&quot;components/Document.jsx&quot;:null,&quot;components/Header.jsx&quot;:null,&quot;components/App.jsx&quot;:null,&quot;components/SelectionContext.jsx&quot;:null,&quot;components/Cell.jsx&quot;:null,&quot;components/CellMenu.jsx&quot;:null,&quot;components/Editor.jsx&quot;:null,&quot;components/CodeMeta.jsx&quot;:null,&quot;components/base/Codeblock.jsx&quot;:null,&quot;components/base/Link.jsx&quot;:null,&quot;components/Backlinks.jsx&quot;:null,&quot;../plugins/viewers/esm.js&quot;:null,&quot;../plugins/transformers/prettier.js&quot;:null,&quot;../manifest.json&quot;:null,&quot;plugins/other/cors-proxy.js&quot;:null,&quot;testing/repl-output.svg&quot;:null,&quot;/transfomers.lit&quot;:null,&quot;/renderer/viewers.lit&quot;:null,&quot;test.js&quot;:null,&quot;test.ts&quot;:null,&quot;test.jsx&quot;:null,&quot;overview.svg&quot;:null,&quot;/interactive_notebooks.lit&quot;:null,&quot;/wiki.lit&quot;:null,&quot;/guided_learning.lit&quot;:null,&quot;/rapid_prototyping.lit&quot;:null,&quot;/transformers.lit&quot;:null,&quot;influences.svg&quot;:null,&quot;manifest.json&quot;:null,&quot;/divergence_from_markdown.html&quot;:null,&quot;/dummy/ðŸ”¥.html&quot;:null,&quot;/index.html&quot;:null,&quot;/meta/the_bazaar.html&quot;:null,&quot;/plugins/viewers/plantuml/plantuml.html&quot;:null,&quot;/testing/log/2021-05-29.html&quot;:null,&quot;/testing/log/2021-06-01.html&quot;:null,&quot;/testing/log/2021-06-02.html&quot;:null,&quot;/testing/log/day.html&quot;:null,&quot;/throwaway/codevaluebug.html&quot;:null,&quot;../.github/workflows/generate.yaml&quot;:null,&quot;meta/.github/workflows/npm-publish.yaml&quot;:null,&quot;client/style.styl&quot;:null,&quot;client/styles/cell.styl&quot;:null,&quot;client/styles/codecell.styl&quot;:null,&quot;client/styles/cellmenu.styl&quot;:null,&quot;client/styles/viewers.styl&quot;:null,&quot;/unified.lit&quot;:null,&quot;/remark.lit&quot;:null,&quot;/markdown.lit&quot;:null,&quot;/utils/unist-patch-source.lit&quot;:null,&quot;parser/index.js&quot;:null,&quot;parser/frontmatter.js&quot;:null,&quot;parser/sections.js&quot;:null,&quot;parser/codeblocks.js&quot;:null,&quot;parser/mdblocks.js&quot;:null,&quot;parser/links.js&quot;:null,&quot;/config.lit#github&quot;:null,&quot;utils/fs-promises-gh-utils.js&quot;:null,&quot;plugins/viewers/meta.js&quot;:null,&quot;/meta/settings.lit#plantuml-viewer--repl&quot;:null,&quot;plugins/repls/module.js&quot;:null,&quot;/components.lit&quot;:null,&quot;renderer/index.jsx&quot;:null,&quot;renderer/extractPlugins.js&quot;:null,&quot;renderer/transcludeCode.js&quot;:null,&quot;index.js&quot;:null,&quot;/index&quot;:null,&quot;/utils/fs.lit&quot;:null,&quot;/utils/uri.lit&quot;:null,&quot;/undefined.lit&quot;:null,&quot;filename&quot;:null,&quot;dummy/ðŸ”¥.lit&quot;:null,&quot;dummy/example.svg&quot;:null,&quot;dummy/plain.txt&quot;:null,&quot;dummy/data.csv&quot;:null,&quot;runkit-express-cors-proxy.js&quot;:null,&quot;../plugins/other/cors-proxy.js&quot;:null,&quot;repl-output.svg&quot;:null,&quot;testing/testing/repl-output.svg&quot;:null,&quot;../plugins/viewers/search.js&quot;:null,&quot;../plugins/repls/search.js&quot;:null,&quot;../plugins/repls/module.js&quot;:null,&quot;custom-module.mjs&quot;:null,&quot;/testing/log/2021-w23.lit&quot;:null,&quot;testing/log/checkforinput.js&quot;:null,&quot;testing/log/today.js&quot;:null,&quot;log/checkforinput.js&quot;:null,&quot;log/today.js&quot;:null,&quot;testing/log/day.lit&quot;:null,&quot;../utils/git-commit-all.js&quot;:null,&quot;gitworker.js&quot;:null,&quot;fsviewer.jsx&quot;:null,&quot;/agora.lit&quot;:null,&quot;/testing/undefined.lit&quot;:null,&quot;/parser.lit&quot;:null,&quot;testing/test.txt&quot;:null,&quot;/testing/log/2021-w22.lit&quot;:null,&quot;/distributed_knowledge_graph.lit&quot;:null,&quot;/experimental_social_network.lit&quot;:null,&quot;/testing/log/2021-06.lit&quot;:null,&quot;/testing/log/2021-w24.lit&quot;:null,&quot;rk.jsx&quot;:null,&quot;runkit-repl-endpoint.js&quot;:null,&quot;../plugins/repls/node.js&quot;:null,&quot;testing/getserviceworker--sw&quot;:null,&quot;../serviceworker.js&quot;:null,&quot;worker.js&quot;:null,&quot;worker2.js&quot;:null,&quot;utils/functions.js&quot;:null,&quot;utils/console.js&quot;:null,&quot;utils/colors.js&quot;:null,&quot;utils/safe-encoders.js&quot;:null,&quot;utils/unist-util-patch-source.js&quot;:null,&quot;utils/unist-util-select-position.js&quot;:null,&quot;utils/fs-promises-utils.js&quot;:null,&quot;utils/git-commit-all.js&quot;:null,&quot;utils/momento.js&quot;:null,&quot;plugins/viewers/md/index.jsx&quot;:null,&quot;viewers/meta.js&quot;:null,&quot;plugins/viewers/diff.js&quot;:null}
5978-&gt;4663. A 21.997323519571765% reduction in size.
</code></pre></output></codecell></div></cell><cell startpos="31:1-6933" endpos="31:40-6972"><div class="cell-content"><p>Looking up a file, check for existence:</p></div></cell><cell startpos="32:1-6973" endpos="47:4-7378" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async (fn) =&gt; {
  const { CompactPrefixTree, getWordsFromTrie } = await import(
    &quot;https://cdn.skypack.dev/compact-prefix-tree&quot;
  );

  const json = await fetch(&quot;/testing/compactManifest1.json&quot;).then((res) =&gt;
    res.json()
  );
  // return json
  const keys = getWordsFromTrie(json);
  const trie = new CompactPrefixTree(Array.from(keys));
  return trie.prefix(&quot;testing/log/&quot;);
})();

</code></pre></codecell></div></cell><cell startpos="48:1-7379" endpos="50:4-7463" class="code output"><div class="cell-content"><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">2.6w ago</span></span></span><output><pre><code class="txt">{ prefix: &#x27;testing/log/day.lit&#x27;, isProper: true }
</code></pre></output></codecell></div></cell><cell startpos="51:1-7464" endpos="53:4-7529" class="code output"><div class="cell-content"><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">2.6w ago</span></span></span><output><pre><code class="txt">{ prefix: &#x27;&#x27;, isProper: false }
</code></pre></output></codecell></div></cell></section></section>
<section depth="2" class="" startpos="55:1-7531" endpos="146:4-9971"><cell startpos="55:1-7531" endpos="55:11-7541"><div class="cell-content"><h2 id="a-start">A Start</h2></div></cell><cell startpos="57:1-7543" endpos="73:4-7961" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async (fn) =&gt; {
  const { CompactPrefixTree, getWordsFromTrie } = lit.utils.compactPrefixTree;

  const resp = await fetch(&quot;/compactManifest.json&quot;);
  const data = await resp.json();
  const keyset = getWordsFromTrie(data);
  const list = Array.from(keyset).map(k=&gt;`/${k}`)
  console.log(list[50])
  return list.length
})();

</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">7.0d ago</span></span></span><output><pre><code class="txt">/parser/frontmatter.js
159
</code></pre></output></codecell></div></cell><cell startpos="75:1-7963" endpos="75:67-8029"><div class="cell-content"><ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->Use the above to sync local file system instead of manifest.</li>
</ul></div></cell><cell startpos="76:1-8030" endpos="146:4-9971" class="code"><div class="cell-content"><codecell class="dir-collapse tag-sync lang-js local collapsed"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span style="color:white;background-color:#0361a9" class="tag">sync</span></span><pre><code class="js">// fetch all remote files and store
// locally if they don&#x27;t already exist

const getList = async () =&gt; {
  const { CompactPrefixTree, getWordsFromTrie } = lit.utils.compactPrefixTree;

  const resp = await fetch(&quot;/compactManifest.json&quot;);
  const data = await resp.json();
  const keyset = getWordsFromTrie(data);
  const list = Array.from(keyset).map((k) =&gt; `/${k}`);
  return list;
};

return (async (fn) =&gt; {
  const t = Date.now();
  const p = lit.utils.path;
  const writePLocal = async (...args) =&gt; {};

  const list = await getList();

  const existed = []
  const duds = [];
  const synced = [];
  const errors = [];
  const res = await Promise.all(
    list.map(async (n) =&gt; {
      try {
        const stats = await lit.fs
          .readStat(n)
          .then((x) =&gt; x)
          .catch((err) =&gt; {
            duds.push(n);
            return { local: {}, remote: {} };
          });
        if (stats.local.stat) {
          existed.push(n)
        }
        else if (stats.remote.stat) {
          await lit.fs.writeFile(n, stats.remote.value, {
            localOnly: true,
            encoding: &quot;utf8&quot;,
          });
          synced.push(n);
        } else {
          errors.push(n)
        }

        return n;
      } catch (err) {
        errors.push(n + &quot; : &quot; + err.message);
      }
    })
  );
  console.log(
    `Synced ${synced.length + existed.length}/${list.length} files in ${
      (Date.now() - t) / 1000
    } seconds. Fetched: ${synced.length} Duds: ${duds.length} Errors: ${errors.length} Skipped: ${existed.length}`
  );
  return { duds, errors };
})();

</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">6.9d ago</span></span></span><output><pre><code class="txt">Synced 156/159 files in 3.242 seconds. Fetched: 0 Duds: 0 Errors: 3 Skipped: 156
{ duds: [],
  errors: 
   [ &#x27;/testing/uploads/B98FC982-EB37-427B-A7D7-D872628323C0.png&#x27;,
     &#x27;/testing/uploads/graph.png&#x27;,
     &#x27;/testing/uploads/EC0FF74E-93A5-496D-A5A7-1F2FC1885F77.png.png&#x27; ] }
</code></pre></output></codecell></div></cell></section></div></div><div id="backlinks"><h4>Backlinks (2)</h4><ol><li><a title="ðŸ”¬ Testing Fuzzy text search" href="/testing/fuzzy_text_search.html">ðŸ”¬ Testing Fuzzy text search</a></li><li><a title="ðŸ”¬ Tests, experiments and investigations" href="/testing/index.html">ðŸ”¬ Tests, experiments and investigations</a></li></ol></div><script src="//cdn.jsdelivr.net/npm/eruda"></script><script>eruda.init();</script><script async="" src="/web.bundle.js"></script></body></html>