<html data-reactroot=""><head><title>Compact Manifest</title><meta name="litsrc" value="/testing/compact_manifest.lit"/><meta name="litroot" value="/"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/railscasts.css"/><link rel="stylesheet" href="/style.css"/></head><body><div id="lit-app"><div id="lit-header"><menu class="horizontal open has-children"><li class="MenuTitle"><a href="/">Home</a></li><li class="MenuItems"><menu class="has-children"><li class="MenuTitle">File</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Cell</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Section</li></menu><menu class="has-children"><li class="MenuTitle">Help</li></menu><menu class="has-children right"><li class="MenuTitle"><span class="led led-grey"></span></li></menu></li></menu><div class="lit-messages"></div></div><div id="content"><section depth="1" class="" startpos="1:1-0" endpos="51:4-1415"><cell startpos="1:1-0" endpos="3:78-97"><div class="cell-content"><h1 id="compact-manifest">Compact Manifest</h1><p>Reducing the serialised size of a manifest of all files in a <code>.lit</code> notebook.</p></div></cell><section depth="2" class="" startpos="5:1-99" endpos="51:4-1415"><cell startpos="5:1-99" endpos="7:84-196"><div class="cell-content"><h2 id="exploring">Exploring</h2><p>Trying out <a href="https://github.com/sidvishnoi/compact-prefix-tree" filepath="/testing/compact_manifest.lit" root="" data="[object Object]">compact-prefix-tree<span class="linkIcon">â†—</span></a></p></div></cell><cell startpos="8:1-197" endpos="25:4-815" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async fn =&gt; {
  const {CompactPrefixTree} = await import(&#x27;https://cdn.skypack.dev/compact-prefix-tree&#x27;)

  const manifest = await fetch(&#x27;/manifest.json&#x27;).then(res =&gt; res.json())
  const keys = manifest.nodes.map(n=&gt;n.id)
  const trie = new CompactPrefixTree(keys)

  const before = JSON.stringify(keys)
  const after = JSON.stringify(trie.T)
  // console.log(trie.T)
  await lit.fs.writeFile(&#x27;/testing/compactManifest1.json&#x27;, after, &#x27;utf8&#x27;)
  return `A ${after.length/before.length*100}% reduction in size.`
})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">8.5h ago</span></span></span><output><pre><code class="txt">A 95.31428571428572% reduction in size.
</code></pre></output></codecell></div></cell><cell startpos="29:1-819" endpos="29:40-858"><div class="cell-content"><p>Looking up a file, check for existence:</p></div></cell><cell startpos="30:1-859" endpos="45:4-1264" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async (fn) =&gt; {
  const { CompactPrefixTree, getWordsFromTrie } = await import(
    &quot;https://cdn.skypack.dev/compact-prefix-tree&quot;
  );

  const json = await fetch(&quot;/testing/compactManifest1.json&quot;).then((res) =&gt;
    res.json()
  );
  // return json
  const keys = getWordsFromTrie(json);
  const trie = new CompactPrefixTree(Array.from(keys));
  return trie.prefix(&quot;testing/log/&quot;);
})();

</code></pre></codecell></div></cell><cell startpos="46:1-1265" endpos="48:4-1349" class="code output"><div class="cell-content"><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">1.7w ago</span></span></span><output><pre><code class="txt">{ prefix: &#x27;testing/log/day.lit&#x27;, isProper: true }
</code></pre></output></codecell></div></cell><cell startpos="49:1-1350" endpos="51:4-1415" class="code output"><div class="cell-content"><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">1.7w ago</span></span></span><output><pre><code class="txt">{ prefix: &#x27;&#x27;, isProper: false }
</code></pre></output></codecell></div></cell></section></section>
<section depth="2" class="" startpos="53:1-1417" endpos="140:4-3660"><cell startpos="53:1-1417" endpos="53:11-1427"><div class="cell-content"><h2 id="a-start">A Start</h2></div></cell><cell startpos="55:1-1429" endpos="71:4-1847" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async (fn) =&gt; {
  const { CompactPrefixTree, getWordsFromTrie } = lit.utils.compactPrefixTree;

  const resp = await fetch(&quot;/compactManifest.json&quot;);
  const data = await resp.json();
  const keyset = getWordsFromTrie(data);
  const list = Array.from(keyset).map(k=&gt;`/${k}`)
  console.log(list[50])
  return list.length
})();

</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">8.3h ago</span></span></span><output><pre><code class="txt">/parser/frontmatter.js
159
</code></pre></output></codecell></div></cell><cell startpos="73:1-1849" endpos="73:67-1915"><div class="cell-content"><ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->Use the above to sync local file system instead of manifest.</li>
</ul></div></cell><cell startpos="74:1-1916" endpos="140:4-3660" class="code"><div class="cell-content"><codecell class="dir-collapse tag-sync lang-js local collapsed"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span style="color:white;background-color:#0361a9" class="tag">sync</span></span><pre><code class="js">// fetch all remote files and store
// locally if they don&#x27;t already exist

const getList = async () =&gt; {
  const { CompactPrefixTree, getWordsFromTrie } = lit.utils.compactPrefixTree;

  const resp = await fetch(&quot;/compactManifest.json&quot;);
  const data = await resp.json();
  const keyset = getWordsFromTrie(data);
  const list = Array.from(keyset).map((k) =&gt; `/${k}`);
  return list;
};

return (async (fn) =&gt; {
  const t = Date.now();
  const p = lit.utils.path;
  const writePLocal = async (...args) =&gt; {};

  const list = await getList();

  const existed = []
  const duds = [];
  const synced = [];
  const errors = [];
  const res = await Promise.all(
    list.map(async (n) =&gt; {
      try {
        const stats = await lit.fs
          .readStat(n)
          .then((x) =&gt; x)
          .catch((err) =&gt; {
            duds.push(n);
            return { local: {}, remote: {} };
          });
        if (stats.local.stat) {
          existed.push(n)
        }
        else if (stats.remote.stat) {
          await lit.fs.writeFile(n, stats.remote.value, {
            localOnly: true,
            encoding: &quot;utf8&quot;,
          });
          synced.push(n);
        } else {
          errors.push(n)
        }

        return n;
      } catch (err) {
        errors.push(n + &quot; : &quot; + err.message);
      }
    })
  );
  console.log(
    `Synced ${synced.length + existed.length}/${list.length} files in ${
      (Date.now() - t) / 1000
    } seconds. Fetched: ${synced.length} Duds: ${duds.length} Errors: ${errors.length} Skipped: ${existed.length}`
  );
  return { duds, errors };
})();

</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">8h ago</span></span></span><output><pre><code class="txt">Synced 22/159 files in 1.766 seconds. Duds: 0 Errors: 0
{ duds: [], errors: [] }
</code></pre></output></codecell></div></cell></section></div></div><div id="backlinks"><h4>Backlinks (2)</h4><ol><li><a title="Fuzzy text search" href="/testing/fuzzy_text_search.html">Fuzzy text search</a></li><li><a title="ðŸ”¬ Tests, experiments and investigations" href="/testing/index.html">ðŸ”¬ Tests, experiments and investigations</a></li></ol></div><script src="//cdn.jsdelivr.net/npm/eruda"></script><script>eruda.init();</script><script async="" src="/web.bundle.js"></script></body></html>