<html data-reactroot=""><head><title>Isomorphic Git</title><meta name="litsrc" value="/testing/isomorphic_git.lit"/><meta name="litroot" value="/"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><link rel="stylesheet" href="/style.css"/></head><body><div id="lit-app"><div id="lit-header"><menu class="horizontal open has-children"><li class="MenuTitle"><a href="/">Home</a></li><li class="MenuItems"><menu class="has-children" disabled=""><li class="MenuTitle">File</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Cell</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Section</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Help</li></menu><menu class="has-children right"><li class="MenuTitle"><span class="led led-grey"></span><span class="led led-grey"></span><span class="led led-grey"></span></li></menu></li></menu></div><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.0/build/styles/sunburst.min.css"/><div id="content"><section id="isomorphic-git" depth="1" class="" startpos="1:1-0" endpos="6:21-203"><cell startpos="1:1-0" endpos="4:163-181"><div class="cell-content"><h1>Isomorphic Git</h1><p>Since <code>.lit</code> already uses <a class="exists local" href="lightningfs.html" title="testing/LightningFS" wikilink="true" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="/testing/lightningfs.lit">testing/LightningFS</a> for the local filesystem we can easily use <a class="external" href="https://isomorphic-git.org/docs/en/quickstart" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="https://isomorphic-git.org/docs/en/quickstart">https://isomorphic-git.org/docs/en/quickstart<span class="linkIcon">↗</span></a> to manage versioning...</p></div></cell><section id="table-of-contents" depth="2" class="" startpos="6:1-183" endpos="6:21-203"><cell startpos="6:1-183" endpos="6:21-203"><div class="cell-content"><h2>Table of Contents</h2><ul>
<li>
<p><a class="fragment" href="#initial-plan" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="#initial-plan">Initial plan<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a class="fragment" href="#investigating-api" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="#investigating-api">Investigating API<span class="linkIcon">§</span></a></p>
<ul>
<li><a class="fragment" href="#status" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="#status">Status<span class="linkIcon">§</span></a></li>
<li><a class="fragment" href="#add" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="#add">Add<span class="linkIcon">§</span></a></li>
<li><a class="fragment" href="#commit" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="#commit">Commit<span class="linkIcon">§</span></a></li>
<li><a class="fragment" href="#log" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="#log">Log<span class="linkIcon">§</span></a></li>
<li><a class="fragment" href="#diff" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="#diff">Diff<span class="linkIcon">§</span></a></li>
</ul>
</li>
<li>
<p><a class="fragment" href="#http-client" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="#http-client">Http client<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a class="fragment" href="#web-worker" filepath="/testing/isomorphic_git.lit" root="" data="[object Object]" canonical="#web-worker">Web worker<span class="linkIcon">§</span></a></p>
</li>
</ul></div></cell></section></section>
<section id="initial-plan" depth="2" class="" startpos="8:1-205" endpos="88:4-2205"><cell startpos="8:1-205" endpos="14:17-453"><div class="cell-content"><h2>Initial plan</h2><p>The initial plan is to just auto commit on all actions, enabling &quot;infinite&quot; undo.</p><p>Thereafter that may remain the default but ideally an ergonomic version of the raw git api can be exposed for more advanced users.</p><p><em>Implementation</em></p></div></cell><cell startpos="20:1-459" endpos="68:4-1657" class="code"><div class="cell-content"><codecell class="dir-plugin dir-collapse lang-js local collapsed"><a name="git-commit-all"></a><span class="meta"><span class="lang">js</span><span class="filename">../utils/git-commit-all.js</span><span style="color:white;background-color:#c5476f" class="directive dir-plugin">plugin</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span class="attribute attr-type" style="color:white;background-color:#0368f3">type=fn</span><span class="attribute attr-id" style="color:black;background-color:#00d1b0">id=git-commit-all</span></span><pre><code class="js">// initially, because it&#x27;s on every change 
// a commit will mostly be for a single
// file at a time the immediate exception 
// being when a file with output files 
// is edited, in which case the commit 
// includes those files.

export const fn = async () =&gt; {
  const now = (new Date()).toISOString()

  const fs = lit.lfs 
  const dir = lit.location.root
  const git = lit.git
  const FILE = 0, WORKDIR = 2, STAGE = 3

  const unstaged = row =&gt; {
    return row[WORKDIR] !== row[STAGE]
  }

  // get/list unstaged files
  const status = await git.statusMatrix({ fs,dir})
  const files = status
                .filter( unstaged )
                .map(row =&gt; row[FILE])

  // stage everything
  await git.add({fs, dir, filepath: &#x27;.&#x27;})

  // message 
  const message = `Commit ${lit.location.src}

at ${now} includes the following ${files.length} files:
${files.map(f=&gt; &quot;- &quot; + f).join(&#x27;\n&#x27;)}`

  // return message

  // commit
  const sha = await git.commit({fs, dir,
    message,
    author: {
      name: &#x27;dotlitbot&#x27;,
      email: &#x27;bot@dotlit.org&#x27;
    }
  })
  return `Committed ${sha.slice(0,6)} 
${message}`
}
</code></pre></codecell></div></cell><cell startpos="69:1-1658" endpos="79:4-1998" class="code"><div class="cell-content"><codecell class="dir-plugin dir-collapse lang-js local collapsed"><a name="git"></a><span class="meta"><span class="lang">js</span><span style="color:white;background-color:#c5476f" class="directive dir-plugin">plugin</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span class="attribute attr-id" style="color:black;background-color:#00d1b0">id=git</span><span class="attribute attr-type" style="color:white;background-color:#0368f3">type=menu</span></span><pre><code class="js">export const menu = (ctx, {React, Menu}) =&gt; {
  const rc = React.createElement
  const commit = lit.file.data.plugins.fn[&#x27;git-commit-all&#x27;]
  const onClick = async ev =&gt; alert(await commit())
  return rc( Menu, {
    title:&quot;Git&quot;,
    disabled: false,
  }, [rc(&#x27;span&#x27;, {onClick}, &#x27;Commit All&#x27;)])
}
</code></pre></codecell></div></cell><cell startpos="80:1-1999" endpos="88:4-2205" class="code"><div class="cell-content"><codecell class="lang-txt local"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">17.4w ago</span></span></span><pre><code class="txt">Committed d738da 
Auto commit testing/isomorphic_git.lit

at: 2021-04-26T08:25:54.893Z
includes the following 2 files:
- testing/isomorphic_git.lit
- utils/git-commit-all.js
</code></pre></codecell></div></cell></section>
<section id="investigating-api" depth="2" class="" startpos="89:1-2206" endpos="225:4-6204"><cell startpos="89:1-2206" endpos="89:21-2226"><div class="cell-content"><h2>Investigating API</h2></div></cell><cell startpos="92:1-2229" endpos="101:4-2395" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return lit.fs
       .readFile(&#x27;/.git/HEAD&#x27;, {
          encoding: &#x27;utf8&#x27;
        })
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">11.9w ago</span></span></span><output><pre><code class="txt">ref: refs/heads/master

</code></pre></output></codecell></div></cell><cell startpos="102:1-2396" endpos="111:4-2593" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return lit.fs
       .readFile(&#x27;/.git/refs/heads/master&#x27;, {
          encoding: &#x27;utf8&#x27;
        })
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">11.9w ago</span></span></span><output><pre><code class="txt">c87e4931458d48d27b0b1aeec2f48da44b88d027

</code></pre></output></codecell></div></cell><cell startpos="112:1-2594" endpos="122:4-2774" class="code"><div class="cell-content"><codecell class="tag-init lang-js local"><span class="meta"><span class="lang">js</span><span style="color:white;background-color:#031651" class="tag">init</span></span><pre><code class="js">return (async () =&gt; {
  return await lit.git.init({
    fs: lit.lfs, 
    dir: lit.location.root
  })
})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">11.9w ago</span></span></span><output><pre><code class="txt">undefined
</code></pre></output></codecell></div></cell><section id="status" depth="3" class="" startpos="123:1-2775" endpos="225:4-6204"><cell startpos="123:1-2775" endpos="123:11-2785"><div class="cell-content"><h3>Status</h3></div></cell><cell startpos="125:1-2787" endpos="136:4-3037" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async () =&gt; {
  return lit.location.src + &quot; : &quot; + await lit.git.status({
    fs: lit.lfs, 
    dir: lit.location.root, 
    filepath: &#x27;.&#x27; 
  })
})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">14.2w ago</span></span></span><output><pre><code class="txt">testing/isomorphic_git.lit : *added
</code></pre></output></codecell></div></cell><cell startpos="137:1-3038" endpos="205:4-5791" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async () =&gt; {
  return await lit.git.statusMatrix({
    fs: lit.lfs, 
    dir: lit.location.root, 
    filepaths: [&#x27;testing/&#x27;]
  })
})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">11.9w ago</span></span></span><output><pre><code class="txt">[ [ &#x27;testing/&lt;&#x27;, 1, 1, 1 ],
  [ &#x27;testing/autoformatting_cell_source.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/autoformatting_cell_source.lit#prettier&#x27;, 1, 1, 1 ],
  [ &#x27;testing/compactManifest1.json&#x27;, 1, 1, 1 ],
  [ &#x27;testing/compact_manifest.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/cors_proxy.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/custom-module.js&#x27;, 1, 1, 1 ],
  [ &#x27;testing/custom-module.mjs&#x27;, 1, 1, 1 ],
  [ &#x27;testing/esm_viewer_repl.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/full.json&#x27;, 1, 1, 1 ],
  [ &#x27;testing/fuzzy_text_search.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/gitworker.js&#x27;, 1, 1, 1 ],
  [ &#x27;testing/importing_js_modules.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/index.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/input_buffer.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/isomorphic_git.lit&#x27;, 1, 2, 1 ],
  [ &#x27;testing/lightningfs.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/links.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/local_remote_files.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-09.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-11.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-12.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-13.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-15.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-16.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-17.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-18.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-19.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-20.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-21.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-23.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-25.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-27.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-29.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05-30.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-05.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-06-01.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-06-02.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-w20.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021-w21.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/2021.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/checkforinput.js&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/day.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/log/today.js&#x27;, 1, 1, 1 ],
  [ &#x27;testing/paths.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/private_files.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/repl-output.svg&#x27;, 1, 1, 1 ],
  [ &#x27;testing/runkit-cors-proxy-endpoint.js&#x27;, 1, 1, 1 ],
  [ &#x27;testing/runkit-express-cors-proxy.js&#x27;, 1, 1, 1 ],
  [ &#x27;testing/runkit-repl-endpoint.js&#x27;, 1, 1, 1 ],
  [ &#x27;testing/runkit.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/selection.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/serviceworker.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/test.txt&#x27;, 1, 1, 1 ],
  [ &#x27;testing/testing/repl-output.svg&#x27;, 1, 1, 1 ],
  [ &#x27;testing/web_workers.lit&#x27;, 1, 1, 1 ],
  [ &#x27;testing/worker.js&#x27;, 1, 1, 1 ],
  [ &#x27;testing/worker2.js&#x27;, 1, 1, 1 ] ]
</code></pre></output></codecell></div></cell><cell startpos="209:1-5795" endpos="225:4-6204" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">const fs = lit.lfs 
const dir = lit.location.root
const git = lit.git
const FILE = 0, WORKDIR = 2, STAGE = 3

// list files with unstaged changes
return (async () =&gt; {
  const filenames = (await git.statusMatrix({ fs,dir}))
  .filter(row =&gt; row[WORKDIR] !== row[STAGE])
  .map(row =&gt; row[FILE])
  return filenames
})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">11.9w ago</span></span></span><output><pre><code class="txt">[ &#x27;testing/isomorphic_git.lit&#x27; ]
</code></pre></output></codecell></div></cell></section></section>
<section id="add" depth="3" class="" startpos="226:1-6205" endpos="243:4-6427"><cell startpos="226:1-6205" endpos="226:8-6212"><div class="cell-content"><h3>Add</h3></div></cell><cell startpos="228:1-6214" endpos="243:4-6427" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">
const fs = lit.lfs
const dir = lit.location.root

return (async ()=&gt; {
  return await lit.git.add({
    fs,
    dir,
    filepath: &#x27;.&#x27;
  })
})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">11.9w ago</span></span></span><output><pre><code class="txt">undefined
</code></pre></output></codecell></div></cell></section>
<section id="commit" depth="3" class="" startpos="247:1-6431" endpos="273:4-6834"><cell startpos="247:1-6431" endpos="247:11-6441"><div class="cell-content"><h3>Commit</h3></div></cell><cell startpos="249:1-6443" endpos="273:4-6834" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">
const fs = lit.lfs
const dir = lit.location.root

return (async ()=&gt; {
const now = (new Date()).toISOString()
let sha = await lit.git.commit({
  fs,
  dir,
  message: `Auto commit (${now})`,
  author: {
    name: &#x27;dotlit&#x27;,
    email: &#x27;bit@dotlit.org&#x27;
  }
})

console.log(sha)

})()
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">11.9w ago</span></span></span><output><pre><code class="txt">46ceec21a687227f28f6f1ca3139b6a0cd37fad5
undefined
</code></pre></output></codecell></div></cell></section>
<section id="log" depth="3" class="" startpos="275:1-6836" endpos="304:4-7492"><cell startpos="275:1-6836" endpos="275:8-6843"><div class="cell-content"><h3>Log</h3></div></cell><cell startpos="277:1-6845" endpos="304:4-7492" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span><span class="output">&gt; md</span></span><pre><code class="js">const indentLines = str =&gt; str.split(&#x27;\n&#x27;).map( line =&gt; `      ${line}`).join(&#x27;\n&#x27;)

return (async ()=&gt; {
  let commits = await lit.git.log({
     fs: lit.lfs, 
     dir: lit.location.root, 
     depth: 10
  })
  return &quot;**Log**\n&quot; + commits.map( x =&gt; `1. **\`${x.oid.slice(0,6)}\`**

${indentLines(x.commit.message)}`).join(&#x27;\n&#x27;)
})()
</code></pre></codecell><codecell class="lang-md local output"><span class="meta"><span class="lang">md</span><span class="updatedAt">Updated <span class="Time relative">11.9w ago</span></span></span><div class="md-block">
<p><strong>Log</strong></p>
<ol>
<li>
<p><strong><code>c87e49</code></strong></p>
<p>Commit /testing/isomorphic_git.lit</p>
<p>at 2021-06-03T13:14:34.272Z includes the following 1 files:</p>
<ul>
<li>testing/isomorphic_git.lit</li>
</ul>
</li>
<li>
<p><strong><code>46ceec</code></strong></p>
<p>Auto commit (2021-06-03T13:10:44.622Z)</p>
</li>
</ol>
</div></codecell></div></cell></section>
<section id="diff" depth="3" class="" startpos="306:1-7494" endpos="331:4-8114"><cell startpos="306:1-7494" endpos="306:9-7502"><div class="cell-content"><h3>Diff</h3></div></cell><cell startpos="308:1-7504" endpos="314:4-7651" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">const {git, lfs} = lit
return [git.walk, git.TREE]
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">15.7w ago</span></span></span><output><pre><code class="txt">[ [Function: walk], [Function: TREE] ]
</code></pre></output></codecell></div></cell><cell startpos="315:1-7652" endpos="331:4-8114" class="code"><div class="cell-content"><codecell class="dir-collapse lang-js local collapsed"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span></span><pre><code class="js">return lit.git
  const commitHash1 = &#x27;0c40ed746ebe53cf744d78191d0bbc2941537280&#x27;
  const commitHash2 = &#x27;b081f51cd27f54cf58915512006838d4eb67716b&#x27;
  const git = lit.git
  return git.walk({
    lit.lfs,
    lit.location.root,
    trees: [git.TREE({ ref: commitHash1 }), git.TREE({ ref: commitHash2 })],
    map: async function(filepath, [A, B]) {
      return filepath
    })
  )}
</code></pre></codecell><codecell class="dir-error lang-txt local output"><span class="meta"><span class="lang">txt</span><span style="color:white;background-color:red" class="directive dir-error">error</span><span class="updatedAt">Updated <span class="Time relative">15.7w ago</span></span></span><output><pre><code class="txt">undefined
</code></pre></output></codecell></div></cell></section>
<section id="http-client" depth="2" class="" startpos="333:1-8116" endpos="381:4-9266"><cell startpos="333:1-8116" endpos="335:23-8154"><div class="cell-content"><h2>Http client</h2><p>Requires a CORS Proxy!</p></div></cell><cell startpos="337:1-8156" endpos="338:4-8240" class="code"><div class="cell-content"><codecell class="dir-plugin dir-collapse lang-js local collapsed"><a name="corsProxy"></a><span class="meta"><span class="lang">js</span><span style="color:white;background-color:#c5476f" class="directive dir-plugin">plugin</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span class="attribute attr-type" style="color:white;background-color:#0368f3">type=proxy</span><span class="attribute attr-id" style="color:black;background-color:#00d1b0">id=corsProxy</span><span class="source">&lt; ../plugins/other/cors-proxy.js</span></span><pre><code class="js">export const proxy = async (returnEndpoint) =&gt; {
  const setup = (resolve, reject) =&gt; {
    if (typeof lit === &quot;undefined&quot;) reject(&quot;No lit&quot;);
    else if (!window.__runkitCORSProxyEnpoint) {
      (async (fn) =&gt; {
        const rkEmbed = document.createElement(&quot;script&quot;);
        rkEmbed.onload = async (fn) =&gt; {
          const el = document.createElement(&quot;div&quot;);
          document.body.appendChild(el);
          el.setAttribute(&quot;style&quot;, &quot;height:0;&quot;);
          RunKit.createNotebook({
            element: el,
            mode: &quot;endpoint&quot;,
            onLoad: async (rk) =&gt; {
              const endpoint = await rk.getEndpointURL();
              window.__runkitCORSProxyEnpoint = endpoint;
              document.body.removeChild(el);
            },
            evaluateOnLoad: true,
            source: await lit.fs.readFile(
              &quot;/testing/runkit-express-cors-proxy.js&quot;,
              {
                encoding: &quot;utf8&quot;,
              }
            ),
          });
        };
        rkEmbed.setAttribute(&quot;src&quot;, &quot;https://embed.runkit.com&quot;);
        document.body.appendChild(rkEmbed);
      })();
    } else {
      resolve(window.__runkitCORSProxyEnpoint);
    }
  };

  const endpoint = await new Promise(setup).then((e) =&gt; e);
  if (false &amp;&amp; !window.__runkitCORSProxyEnpoint) {
    return &quot;Still setting up proxy endpoint&quot;;
  } else {
    if (returnEndpoint) return endpoint;

    const getAndReplaceDomain = (originalUrl, newDomain) =&gt; {
      return newDomain + originalUrl.replace(/^https?:\/\//, &quot;/&quot;);
    };

    const proxyFetch = async (url, opts = {}) =&gt; {
      const proxyUrl = getAndReplaceDomain(url, endpoint);
      return fetch(proxyUrl, opts);
    };

    return proxyFetch;
  }
};

</code></pre></codecell></div></cell><cell startpos="341:1-8243" endpos="381:4-9266" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return (async (fn) =&gt; {
  const http = await import(
    &quot;https://unpkg.com/isomorphic-git/http/web/index.js&quot;
  );
  return lit.git.getRemoteInfo({
    http: http.default,
    corsProxy: await lit.file.data.plugins.proxy.corsProxy(true),
    url: &quot;https://github.com/dotlitdev/dotlit&quot;,
  });
})();

</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">11.5w ago</span></span></span><output><pre><code class="txt">{ capabilities: 
   [ &#x27;multi_ack&#x27;,
     &#x27;thin-pack&#x27;,
     &#x27;side-band&#x27;,
     &#x27;side-band-64k&#x27;,
     &#x27;ofs-delta&#x27;,
     &#x27;shallow&#x27;,
     &#x27;deepen-since&#x27;,
     &#x27;deepen-not&#x27;,
     &#x27;deepen-relative&#x27;,
     &#x27;no-progress&#x27;,
     &#x27;include-tag&#x27;,
     &#x27;multi_ack_detailed&#x27;,
     &#x27;allow-tip-sha1-in-want&#x27;,
     &#x27;allow-reachable-sha1-in-want&#x27;,
     &#x27;no-done&#x27;,
     &#x27;symref=HEAD:refs/heads/main&#x27;,
     &#x27;filter&#x27;,
     &#x27;object-format=sha1&#x27;,
     &#x27;agent=git/github-g69d6dd5d35d8&#x27; ],
  HEAD: &#x27;refs/heads/main&#x27;,
  refs: 
   { heads: 
      { &#x27;gh-pages&#x27;: &#x27;1bdc2d1a354a7386ce859becb16b2e01d4224456&#x27;,
        main: &#x27;7ea81d7733d7a388fb06a496a2cc630cb66a4308&#x27; },
     pull: { &#x27;1&#x27;: [Object] } } }
</code></pre></output></codecell></div></cell></section>
<section id="web-worker" depth="2" class="" startpos="384:1-9269" endpos="604:4-15024"><cell startpos="384:1-9269" endpos="384:14-9282"><div class="cell-content"><h2>Web worker</h2></div></cell><cell startpos="386:1-9284" endpos="438:4-10711" class="code output"><div class="cell-content"><codecell class="lang-js local output"><a name="gitworker.js"></a><span class="meta"><span class="lang">js</span><span class="filename">gitworker.js</span></span><output><pre><code class="js">/* eslint-env worker */
/* globals LightningFS git MagicPortal GitHttp */
importScripts(
  &quot;https://unpkg.com/@isomorphic-git/lightning-fs&quot;,
  &quot;https://unpkg.com/isomorphic-git@beta&quot;,
  &quot;https://unpkg.com/isomorphic-git@beta/http/web/index.umd.js&quot;,
  &quot;https://unpkg.com/magic-portal&quot;
);

let fs = new LightningFS(&quot;fs&quot;, { wipe: true });
const portal = new MagicPortal(self);
self.addEventListener(&quot;message&quot;, ({ data }) =&gt; console.log(data));

(async () =&gt; {
  let mainThread = await portal.get(&quot;mainThread&quot;);
  let dir = &quot;/&quot;;
  portal.set(&quot;workerThread&quot;, {
    setDir: async _dir =&gt; {
      dir = _dir;
    },
    clone: async args =&gt; {
      fs = new LightningFS(&quot;fs&quot;, { wipe: true });
      try{
      return git.clone({
        ...args,
        fs,
        http: GitHttp,
        dir,
        onProgress(evt) {
          mainThread.progress(evt);
        },
        onMessage(msg) {
          mainThread.print(msg);
        },
        onAuth(url) {
          console.log(url);
          return mainThread.fill(url);
        },
        onAuthFailure({ url, auth }) {
          return mainThread.rejected({ url, auth });
        }
      });
      } catch(err) {
        mainThread.failure({message}=err)
      }
    },
    listBranches: args =&gt; git.listBranches({ ...args, fs, dir }),
    listFiles: args =&gt; git.listFiles({ ...args, fs, dir }),
    log: args =&gt; git.log({ ...args, fs, dir })
  });
})();
</code></pre></output></codecell></div></cell><cell startpos="440:1-10713" endpos="495:4-12361" class="code"><div class="cell-content"><codecell class="dir-collapse tag-reference lang-html local collapsed"><span class="meta"><span class="lang">html</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span style="color:black;background-color:#c8db3f" class="tag">reference</span></span><pre><code class="html">&lt;div&gt;
  &lt;input
    id=&quot;repository&quot;
    type=&quot;text&quot;
    style=&quot;width: 50em&quot;
    title=&quot;Tip: enter a private repo URL to see the credentialManager plugin prompt for a password.&quot;,
    value=&quot;https://github.com/isomorphic-git/isomorphic-git&quot;,
  /&gt;
  &lt;button type=&quot;button&quot; id=&quot;cloneButton&quot;&gt;Clone&lt;/button&gt;
&lt;/div&gt;
&lt;div&gt;
  &lt;progress id=&quot;progress&quot; value=&quot;0&quot;&gt;&lt;/progress&gt;
  &lt;span id=&quot;progress-txt&quot; style=&quot;font-family: monospace;&quot;&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;output id=&quot;log&quot; style=&quot;white-space: pre; font-family: monospace;&quot;&gt;&lt;/output&gt;

&lt;script src=&quot;https://unpkg.com/magic-portal&quot;&gt;&lt;/script&gt;
&lt;script&gt;
  // alert(&quot;Running&quot;)
  const $ = id =&gt; document.getElementById(id);

  let worker = new Worker(&quot;gitworker.js&quot;);
  const portal = new MagicPortal(worker);
  worker.addEventListener(&quot;message&quot;, ({ data }) =&gt; console.log(data));

  const mainThread = {
    async print(message) {
      let text = $(&quot;log&quot;).textContent;
      if (message.endsWith(&quot;\r&quot;)) {
        // overwrite last line
        text = text.trim().replace(/.+$/, &quot;&quot;);
      }
      text += message + &quot;\n&quot;;
      $(&quot;log&quot;).textContent = text;
    },
    async progress(evt) {
      $(&quot;progress-txt&quot;).textContent = evt.phase;
      $(&quot;progress&quot;).value = evt.total ? evt.loaded / evt.total : 0.5;
      return;
    },
    async fill(url) {
      let username = window.prompt(&quot;Username:&quot;);
      let password = window.prompt(&quot;Password:&quot;);
      return { username, password };
    },
    async rejected({ url, auth }) {
      window.alert(&quot;Authentication rejected&quot;);
      return;
    }
  };
  portal.set(&quot;mainThread&quot;, mainThread, {
    void: [&quot;print&quot;, &quot;progress&quot;, &quot;rejected&quot;]
  });

</code></pre></codecell></div></cell><cell startpos="497:1-12363" endpos="499:4-12446" class="code output"><div class="cell-content"><codecell class="dir-below lang-script local output"><span class="meta"><span class="lang">script</span><span style="color:white;background-color:#5948c3" class="directive dir-below">below</span></span><pre><code class="script">https://unpkg.com/magic-portal
</code></pre><div class="scriptLoaded"></div></codecell></div></cell><cell startpos="501:1-12448" endpos="518:4-12902" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return new Promise((resolve,reject) =&gt; {
  let myWorker;
  try {
    myWorker = new Worker(&#x27;gitworker.js&#x27;)
    myWorker.onmessage = (ev) =&gt; {
      if (ev.data === &#x27;done&#x27;) resolve(ev.data)
      else console.log(ev.data)
    }
    myWorker.onerror = (err) =&gt; {
      resolve({msg: &quot;worker.onerror: &quot; + err.message + &quot; (&quot; + err.filename + &quot;:&quot; + err.lineno + &quot;)&quot;, err, err},)
    }
  } catch(err) {
    resolve({msg: &quot;Caught err&quot;, err})
  }
  
})
</code></pre></codecell></div></cell><cell startpos="521:1-12905" endpos="593:4-14821" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">  // alert(&quot;Running&quot;)
  const $ = id =&gt; document.getElementById(id);

  let worker = new Worker(&quot;gitworker.js&quot;);
  const portal = new MagicPortal(worker);
  worker.addEventListener(&quot;message&quot;, ({ data }) =&gt; console.log(data));

  const mainThread = {
    async print(message) {
      console.log(message)
    },
    async progress(evt) {
      console.log(evt.phase, evt.total ? evt.loaded / evt.total : 0.5)
      return;
    },
    async fill(url) {
      let username = window.prompt(&quot;Username:&quot;);
      let password = window.prompt(&quot;Password:&quot;);
      return { username, password };
    },
    async rejected({ url, auth }) {
      window.alert(&quot;Authentication rejected&quot;);
      return;
    }, 
    async failure({message}) {
      alert(&quot;Failure: &quot;, message)
      return
    },
  }
  portal.set(&quot;mainThread&quot;, mainThread, {
    void: [&quot;print&quot;, &quot;progress&quot;, &quot;rejected&quot;, &quot;failure&quot;]
  });

async function doCloneAndStuff() {
    console.log(&quot;CLONE&quot;);

    await workerThread.setDir(&quot;/testing&quot;);

    await workerThread.clone({
      corsProxy: &quot;https://cors.isomorphic-git.org&quot;,
      url: &quot;https://GitHub.com/dotlitdev/dotlit&quot;
    });
    console.log(&quot;CLONED!!&quot;)

    let branches = await workerThread.listBranches({ remote: &quot;origin&quot; });
    console.log(&quot;BRANCHES:\n&quot; + branches.map(b =&gt; `  ${b}`).join(&quot;\n&quot;))

    let files = await workerThread.listFiles({});
    console.log(&quot;FILES:\n&quot; + files.map(b =&gt; `  ${b}`).join(&quot;\n&quot;))

    let commits = await workerThread.log({});
    console.log(&quot;LOG:\n&quot; +
      commits
        .map(c =&gt; `  ${c.oid.slice(0, 7)}: ${c.commit.message}`)
        .join(&quot;\n&quot;))
  }

  return (async () =&gt; {
    const workerThread = await portal.get(&quot;workerThread&quot;);
    window.workerThread = workerThread
    window.worker = worker
    console.log(workerThread)

    console.log(&quot;ready&quot;)
    await doCloneAndStuff()

    
  })();
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">14w ago</span></span></span><output><pre><code class="txt">true
</code></pre></output></codecell></div></cell><cell startpos="595:1-14823" endpos="604:4-15024" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return workerThread.log({})
</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">14w ago</span></span></span><output><pre><code class="txt">{ setDir: [Function],
  clone: [Function],
  listBranches: [Function],
  listFiles: [Function],
  log: [Function] }
</code></pre></output></codecell></div></cell></section></div></div><div id="backlinks"><h4>Backlinks (2)</h4><ol><li><a title=".lit Filesystem" href="/filesystem/index.html">.lit Filesystem</a></li><li><a title="🔬 Tests, experiments and investigations" href="/testing/index.html">🔬 Tests, experiments and investigations</a></li></ol></div><script src="//cdn.jsdelivr.net/npm/eruda"></script><script>eruda.init();</script><script async="" src="/web.bundle.js"></script></body></html>