<html data-reactroot=""><head><title>Fuzzy text search</title><meta name="litsrc" value="testing/fuzzy_text_search.lit"/><meta name="litroot" value="/"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/railscasts.css"/><link rel="stylesheet" href="/style.css"/></head><body><div id="lit-app"><div id="lit-header"><menu class="horizontal open has-children"><li class="MenuTitle"><a href="/">Home</a></li><li class="MenuItems"><menu class="has-children"><li class="MenuTitle">File</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Cell</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Section</li></menu><menu class="has-children"><li class="MenuTitle">Help</li></menu><menu class="has-children right"><li class="MenuTitle"><span class="led led-grey"></span></li></menu></li></menu><div class="lit-messages"><div class="lit-message"><span class="message">Plugin Error (viewer): /home/runner/work/dotlit/dotlit/search.jsx: Unexpected token, expected &quot;,&quot; (75:1)

  73 |     &lt;/div&gt;
  74 |   );
&gt; 75 | };
     |  ^
  76 |</span><span class="name">113:1-190:4</span></div></div></div><div id="content"><section depth="1" class="" startpos="1:1-0" endpos="2853:4-77420"><cell startpos="1:1-0" endpos="5:31-60"><div class="cell-content"><h1 id="fuzzy-text-search">Fuzzy text search</h1><p>Related</p><ul>
<li><a href="testing/compact_manifest.html?file=testing/compact_manifest.lit" title="testing/compact_manifest" wikilink="true">testing/compact_manifest</a></li>
</ul></div></cell><section depth="2" class="" startpos="7:1-62" endpos="2853:4-77420"><cell startpos="7:1-62" endpos="11:98-191"><div class="cell-content"><h2 id="fusejs">Fuse.js</h2><p><a href="https://fusejs.io/">https://fusejs.io/<span class="linkIcon">↗</span></a></p><p><a href="https://dev.to/noclat/using-fuse-js-with-react-to-build-an-advanced-search-with-highlighting-4b93">https://dev.to/noclat/using-fuse-js-with-react-to-build-an-advanced-search-with-highlighting-4b93<span class="linkIcon">↗</span></a></p></div></cell><cell startpos="13:1-193" endpos="28:4-603" class="code"><div class="cell-content"><codecell class="dir-collapse tag-intro lang-js local collapsed"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span style="color:black;background-color:#5fb666" class="tag">intro</span></span><pre><code class="js">return (async (fn) =&gt; {
  const { default: Fuse } = await import(
    &quot;https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.esm.js&quot;
  );
  const manifest = await fetch(&quot;/manifest.json&quot;).then((res) =&gt; res.json());
  const fuse = new Fuse(manifest.nodes, {
    includeScore: true,
    keys: [&quot;title&quot;, &quot;id&quot;],
  });

  // 3. Now search!
  return fuse.search(&quot;../../..&quot;,{limit:5});
})();

</code></pre></codecell></div></cell><cell startpos="29:1-604" endpos="112:4-2980" class="code"><div class="cell-content"><codecell class="dir-plugin dir-collapse lang-js local collapsed"><span class="meta"><span class="lang">js</span><span style="color:white;background-color:#c5476f" class="directive dir-plugin">plugin</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span class="attribute attr-type" style="color:white;background-color:#0368f3">type=repl</span><span class="attribute attr-of" style="color:black;background-color:#00dd70">of=search</span></span><pre><code class="js">export const repl = async (src, meta) =&gt; {
  const t = Date.now();

  const { default: Fuse } = await import(
    &quot;https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.esm.js&quot;
  );
  // const manifest = await fetch(&quot;/manifest.json&quot;).then((res) =&gt; res.json());
  // Recursively builds JSX output adding `&lt;mark&gt;` tags around matches
  const highlight = (value, indices = [], i = 1) =&gt; {
    const pair = indices[indices.length - i];
    return !pair
      ? value
      : `${highlight(
          value.substring(0, pair[0]),
          indices,
          i + 1
        )}***${value.substring(pair[0], pair[1] + 1)}***${value.substring(
          pair[1] + 1
        )}`;
  };
  const fullLocal = await (async (fn) =&gt; {
    const path = lit.utils.path;
    const all = [];
    const visit = async (root) =&gt; {
      try {
        const list = await lit.fs.readdir(root);
        return Promise.all(
          list.map(async (key) =&gt; {
            const pathname = path.join(root, key);
            const stat = await lit.fs.stat(pathname);
            let contents;
            if (key === &quot;.git&quot; || !key) {
            } else if (stat.type === &quot;dir&quot;) await visit(pathname);
            else if (pathname.endsWith(&quot;.lit&quot;))
              contents = await lit.fs.readFile(pathname, {
                encoding: &quot;utf8&quot;,
                localOnly: true,
              }); //.slice(0,10);
            const item = { pathname, type: stat.type, contents };
            all.push(item);
            return item;
          })
        );
      } catch (err) {
        alert(err.message);
      }
    };

    await visit(&quot;/&quot;);
    return all;
  })();

  // return fullLocal

  const fuse = new Fuse(fullLocal, {
    ignoreLocation: true,
    includeScore: true,
    includeMatches: true,
    ignoreFieldNorm: true,
    minMatchCharLength: 4,
    keys: [&quot;pathname&quot;, &quot;contents&quot;],
  });

  // 3. Now search!
  const query = src.trim();
  const msg = `Results for search &quot;**${query}**&quot;. In **${
    (Date.now() - t) / 1000
  }** seconds.\n\n`;

  return (
    msg +
    fuse
      .search(query, { limit: 10 })
      //.map(x=&gt;x.matches.map(x=&gt;x.indices))
      .map((x) =&gt; [x.score, x.item.pathname, x.refIndex, x.matches])
      .map(
        ([score, pathname, index, matches]) =&gt; `1. [${pathname}](${pathname})`
      )
      .join(&quot;\n&quot;)
  );
};

</code></pre></codecell></div></cell><cell startpos="113:1-2981" endpos="190:4-5126" class="code"><div class="cell-content"><codecell class="dir-plugin dir-collapse lang-js local collapsed"><a name="search.jsx"></a><span class="meta"><span class="lang">js</span><span class="filename">search.jsx</span><span style="color:white;background-color:#c5476f" class="directive dir-plugin">plugin</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span class="attribute attr-type" style="color:white;background-color:#0368f3">type=viewer</span><span class="attribute attr-of" style="color:black;background-color:#00dd70">of=search2</span></span><pre><code class="js">import Fuse from &quot;https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.esm.js&quot;;
export const viewer = ({ node, React }) =&gt; {

  const {useEffect,useState} = React
  const [msg, setMsg] = useState(&#x27;Searching...&#x27;)
  // const manifest = await fetch(&quot;/manifest.json&quot;).then((res) =&gt; res.json());

  // Recursively builds JSX output adding `&lt;mark&gt;` tags around matches
  const highlight = (value, indices = [], i = 1) =&gt; {
    const pair = indices[indices.length - i];
    return !pair ? (
      value
    ) : (
      &lt;&gt;
        {highlight(value.substring(0, pair[0]), indices, i + 1)}
        &lt;mark&gt;{value.substring(pair[0], pair[1] + 1)}&lt;/mark&gt;
        {value.substring(pair[1] + 1)}
      &lt;/&gt;
    );
  };

  const fullLocal = async (fn) =&gt; {
    const path = lit.utils.path;
    const all = [];
    const visit = async (root) =&gt; {
      try {
        const list = await lit.fs.readdir(root);
        return Promise.all(
          list.map(async (key) =&gt; {
            const pathname = path.join(root, key);
            const stat = await lit.fs.stat(pathname);
            let contents;
            if (key === &quot;.git&quot; || !key) {
            } else if (stat.type === &quot;dir&quot;) await visit(pathname);
            else if (pathname.endsWith(&quot;.lit&quot;))
              contents = await lit.fs.readFile(pathname, {
                encoding: &quot;utf8&quot;,
                localOnly: true,
              }); //.slice(0,10);
            const item = { pathname, type: stat.type, contents };
            all.push(item);
            return item;
          })
        );
      } catch (err) {
        alert(err.message);
      }
    };

    await visit(&quot;/&quot;);
    return all;
  };

  // return fullLocal

  useEffect(async fn =&gt; {
     const t = Date.now();
const fuse = new Fuse(await fullLocal(), {
    ignoreLocation: true,
    includeScore: true,
    includeMatches: true,
    ignoreFieldNorm: true,
    minMatchCharLength: 4,
    keys: [&quot;pathname&quot;, &quot;contents&quot;],
  });

  // 3. Now search!
  const query = node.data.value.trim();

  return (
    &lt;div&gt;
      &lt;span&gt;{msg}&lt;/span&gt;
    &lt;/div&gt;
  );
};

</code></pre></codecell></div></cell><cell startpos="194:1-5130" endpos="2833:4-76495" class="code"><div class="cell-content"><codecell class="lang-text local"><span class="meta"><span class="lang">text</span><span class="repl">search</span><span class="output">&gt; md</span></span><pre><code class="text">test
</code></pre></codecell><codecell class="lang-md local output"><span class="meta"><span class="lang">md</span><span class="updatedAt">Updated <span class="Time relative">7m ago</span></span></span><div class="md-block">
<p>Results for search &quot;<strong>test</strong>&quot;. In <strong>0.077</strong> seconds.</p>
<ol>
<li>
<p><a href="/testing/lightningfs.html">/testing/lightningfs.lit</a></p>
<blockquote>
<p>/<em><strong>test</strong></em>ing/lightningfs.lit ... # Lightning FS</p>
</blockquote>
</li>
</ol>
<p><a href="https://github.com/isomorphic-git/lightning-fs">https://github.com/isomorphic-git/lightning-fs<span class="linkIcon">↗</span></a></p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li>
<p><a href="#bugs-">Bugs 🐜<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#tour-of-the-api">Tour of the API<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#plugins">Plugins<span class="linkIcon">§</span></a></p>
<ul>
<li><a href="#fs-plugin"><code>fs</code> plugin<span class="linkIcon">§</span></a></li>
<li><a href="#finder-local-fs">Finder (local fs)<span class="linkIcon">§</span></a></li>
<li><a href="#finder-from-manifest">Finder (from manifest)<span class="linkIcon">§</span></a></li>
</ul>
</li>
<li>
<p><a href="#sync-localremoteorigin">Sync <code>local|remote|origin</code><span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#emergency-wipe-%EF%B8%8F">Emergency wipe ⚠️<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#table-of-contents-1">Table of Contents<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#initial-plan">Initial plan<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#investigating-api">Investigating API<span class="linkIcon">§</span></a></p>
<ul>
<li><a href="#status">Status<span class="linkIcon">§</span></a></li>
<li><a href="#add">Add<span class="linkIcon">§</span></a></li>
<li><a href="#commit">Commit<span class="linkIcon">§</span></a></li>
<li><a href="#log">Log<span class="linkIcon">§</span></a></li>
<li><a href="#diff">Diff<span class="linkIcon">§</span></a></li>
</ul>
</li>
<li>
<p><a href="#http-client">Http client<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#web-worker">Web worker<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#potential-solutions">Potential solutions<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#-with-prettier">... with prettier<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#table-of-contents-2">Table of Contents<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#embed">Embed<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#endpoint">Endpoint<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#viewer-plug-in">Viewer plug-in<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#repl-endpoint-plug-in-node">REPL endpoint plug-in <code>node</code><span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#next-steps-and-improvements">Next steps and improvements<span class="linkIcon">§</span></a></p>
</li>
<li>
<p><a href="#trying-out-compact-prefix-tree">Trying out <!-- -->compact-prefix-tree<span class="linkIcon">§</span></a></p>
</li>
</ul>
<h2 id="bugs-">Bugs 🐜</h2>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="" disabled=""/> <!-- -->wikiLinks and 404 behaviour results in incorrect/dangling lfs due to incorrect baseUrl.</li>
</ul>
<h2 id="tour-of-the-api">Tour of the API</h2>
<p>•••js
return lit.fs.readdir(&#x27;/<em><strong>test</strong></em>ing/log&#x27;)
•••</p>
<p>•••js &gt; json !collapse
return lit.lfs.promises.writeFile(&#x27;/<em><strong>test</strong></em>ing/data.json&#x27;, &quot;{}&quot;, {encoding: &#x27;utf8&#x27;})
•••
•••&gt;json !collapse attached=true updated=1621193177415
null
•••</p>
<p>•••js &gt; json !collapse
return lit.fs.readFile(&#x27;/doesntexist.json&#x27;)
•••
•••js &gt; json !collapse
return lit.fs.readStat(&#x27;/manifest.json&#x27;)
•••</p>
<p>•••js &gt; json !collapse
return lit.fs
.readStat(&#x27;/manifest.json&#x27;)
.then(stat =&gt; [!!stat.local.value, !!stat.remote.value])
•••
•••&gt;json !collapse attached=true updated=1619878321018
[ true, false ]
•••
•••js &gt; json !collapse
return lit.fs
.stat(&#x27;/notfound&#x27;)
.catch(s =&gt; &quot;404 Not Found&quot;)
•••
•••&gt;json !collapse attached=true updated=1621124612430
404 Not Found
•••
•••js &gt; json !collapse
return lit.fs
.stat(&#x27;/index.lit&#x27;)
.then(stat =&gt; stat)
•••
•••&gt;json !collapse attached=true updated=1619878403441
{ type: &#x27;file&#x27;,
mode: 438,
size: 4589,
ino: 6,
mtimeMs: 1619686223652,
ctimeMs: 1619686223652,
uid: 1,
gid: 1,
dev: 1 }
•••
•••js &gt; diff !collapse
// <a href="https://github.com/kpdecker/jsdiff">https://github.com/kpdecker/jsdiff<span class="linkIcon">↗</span></a>
const {root,src} = lit.location
const {join} = lit.utils.path
const filename = join(root,src)</p>
<p>const withStats = async stats =&gt; {
const cp = lit.utils.diff.createPatch
// const f =
const local = stats.local.value
const remote = stats.remote.value
const patch = cp(filename, local, remote)
console.log(patch.split(&#x27;\n&#x27;).map(l=&gt;&#x27;    &#x27;+l).join(&#x27;\n&#x27;))
return &quot;logged patch&quot;
}</p>
<p>const stats = lit.fs.readStat(filename, {encoding: &#x27;utf8&#x27;})
return stats.then(withStats)
•••
•••&gt;diff !collapse attached=true updated=1620338765234
Index: /<em><strong>test</strong></em>ing/lightningfs.lit
===================================================================
--- /<em><strong>test</strong></em>ing/lightningfs.lit
+++ /<em><strong>test</strong></em>ing/lightningfs.lit
@@ -1697,13 +1697,57 @@</p>
<codecell class="local"><pre><code class="plaintext"></code></pre></codecell>
<p>logged patch
•••
•••js #delete !localonly
const path = &quot;/throwaway/<em><strong>test</strong></em>.txt&quot;
console.log(ast)
return lit.fs.writeFile(path, &quot;content&quot;, {
encoding: &#x27;utf8&#x27;,
localOnly: true
})
•••
•••&gt;txt attached=true updated=1621257066210
{ type: &#x27;element&#x27;,
tagName: &#x27;cell&#x27;,
properties: { class: &#x27;cell&#x27; },
children:
[ { type: &#x27;element&#x27;,
tagName: &#x27;pre&#x27;,
properties: {},
children: [Object],
position: [Object] },
{ type: &#x27;element&#x27;,
tagName: &#x27;pre&#x27;,
properties: {},
children: [Object],
position: [Object] } ],
position:
{ start: { line: 155, column: 1, offset: 51462 },
end: { line: 177, column: 4, offset: 52007 } } }
undefined
•••</p>
<h2 id="plugins">Plugins</h2>
<h3 id="fs-plugin"><code>fs</code> plugin</h3>
<p>•••js
return lit.utils.momento
•••
•••&gt;txt attached=true updated=1621257612846
{ MsToRelative: [G<em><strong>ette</strong></em>r], Da<em><strong>tesT</strong></em>oRelativeDelta: [G<em><strong>ette</strong></em>r] }
•••</p>
<p>•••jsx fsviewer.jsx babel=true !plugin of=fs !collapse
export const viewer = ({node, React}) =&gt; {
const {u<em><strong>seSt</strong></em>ate, useEffect} = React
const {join,extname} = lit.utils.path
const [src, <em><strong>setS</strong></em>rc] = u<em><strong>seSt</strong></em>ate(node?.data?.value?.trim())
const meta = node?.properties?.meta || {}</p>
<p>const styles = {
dir: {fontWeight: &quot;bold&quot;},
&#x27;.lit&#x27;: {color: &#x27;blue&#x27;},
}
const getType = s =&gt; {
const [filepath,stat] = s
if (stat.type === &#x27;file&#x27;) {
return extname(filepath)
}
return stat.type
}</p>
<p>const Stat = (props) =&gt; {
const stat = props?.stat || {}
if (stat.message) return <!-- -->{stat.message}<!-- -->
return <!-- -->
&lt;div style={{marginBottom: &#x27;0.4em&#x27;}}&gt;Type: <!-- -->{stat.type}<!-- --> mtime: <!-- -->{lit.utils.momento.MsToRelative(stat.mtimeMs - Date.now())}<!-- --> Size: <!-- -->{(props.size / 1024).toFixed(2)} KB</p>
<codecell class="local"><pre><code class="plaintext"></code></pre></codecell>
<p>}</p>
<p>const [content, setContent] = u<em><strong>seSt</strong></em>ate(<!-- -->loading...<!-- -->)
const [stat, <em><strong>setSt</strong></em>at] = u<em><strong>seSt</strong></em>ate(undefined)
const [size, <em><strong>setS</strong></em>ize] = u<em><strong>seSt</strong></em>ate(null)</p>
<p>useEffect(async fn =&gt; {
let stat, size
try {
stat = await lit.fs.stat(src)
size = await lit.fs.du(src)
if (stat.type === &#x27;dir&#x27;) {
const list = await lit.fs.readdir(src)
const withStats = list.map( async l =&gt; [l,await lit.fs.stat(join(src,l))])
stat.contents = await Promise.all(withStats)
}
<em><strong>setSt</strong></em>at(stat)
<em><strong>setS</strong></em>ize(size)
} catch(err) {
<em><strong>setSt</strong></em>at(err)
<em><strong>setS</strong></em>ize(null)
}
}, [src])</p>
<p>const bigger = {fontSize: &#x27;1em&#x27;, width: &#x27;100%&#x27;}
return <!-- -->
&lt;input style={bigger} value={src} onChange={ev=&gt;<em><strong>setS</strong></em>rc(ev.target.value)}/&gt;
&lt;div style={{fontFamily: &#x27;monospace&#x27;, marginBottom: &#x27;0.4em&#x27;}}&gt;
<!-- -->
{!stat &amp;&amp; content}
<!-- -->
&lt;button disabled={src === &#x27;/&#x27;} onClick={ev=&gt;  <em><strong>setS</strong></em>rc(src.split(&#x27;/&#x27;).slice(0,-1).join(&#x27;/&#x27;) || &#x27;/&#x27;)}&gt;Back<!-- -->
{stat &amp;&amp; <!-- -->R<em><strong>eset</strong></em>}
{stat &amp;&amp; &lt;button onClick={ev=&gt; confirm(&quot;Are you sure you want to delete &quot; + src) &amp;&amp; lit.fs.unlink(src)}&gt;Delete<!-- -->}
{stat &amp;&amp; <!-- -->Diff<!-- -->}
<!-- -->
}
•••</p>
<p>•••&gt;fs
/
•••</p>
<h3 id="finder-local-fs">Finder (local fs)</h3>
<p>•••js !collapse &gt; json
const path = lit.utils.path;
const visit = async (root) =&gt; {
const list = await lit.fs.readdir(root);
return Promise.all(
list.map(async (key) =&gt; {
const pathname = path.join(root, key);
const stat = await lit.fs.stat(pathname);
let contents;
if (key === &quot;.git&quot; || !key) {
return { key, root,pathname, type: stat.type };
} else if (stat.type === &quot;dir&quot;) {
// alert(&quot;Traversing &quot; + pathname);
contents = await visit(pathname);
} else
contents =
(
await lit.fs.readFile(pathname, {
encoding: &quot;utf8&quot;,
localOnly: true,
})
).slice(0, 10) + &quot;...&quot;;
return { pathname, type: stat.type, contents };
})
);
};</p>
<p>return (async (fn) =&gt; {
lit.fs.writeFile(
&quot;/<em><strong>test</strong></em>ing/full.json&quot;,
JSON.stringify(await visit(&quot;/&quot;), null, 2)
);
})();</p>
<p>•••
•••&gt;json attached=true updated=1621861533762
undefined
•••</p>
<p>•••json2 !inline &lt; full.json</p>
<p>•••</p>
<h3 id="finder-from-manifest">Finder (from manifest)</h3>
<p>•••js !plugin type=viewer !collapse of=search
const sortBy = (keys) =&gt; (a, b) =&gt; {
for (const key of keys) {
if (a[key] !== b[key]) break;
else return a[key] &gt; b[key] ? 1 : -1;
}
};</p>
<p>const itemBuilder = (React) =&gt; (item) =&gt; {
const rc = React.createElement;
return rc(
&quot;li&quot;,
{ className: &quot;item&quot; },
rc(
&quot;a&quot;,
{ href: lit.href || lit.location.root + item.id },
item.title || item.id
)
);
};</p>
<p>export const viewer = ({ node, React }) =&gt; {
const rc = React.createElement;
const { u<em><strong>seSt</strong></em>ate, useEffect } = React;
const meta = node.properties &amp;&amp; node.properties.meta;
const [src, <em><strong>setS</strong></em>rc] = u<em><strong>seSt</strong></em>ate(meta.search || node.data.value.trim());
const [content, setContent] = u<em><strong>seSt</strong></em>ate(&quot;Loading...&quot;);
const item = itemBuilder(React);</p>
<p>useEffect(async () =&gt; {
const resp = await fetch(&quot;/manifest.json&quot;);
const json = await resp.json();
let regex;
try {
regex = new RegExp(src, &quot;i&quot;);
} catch (err) {}
const res = json.nodes
.map((x) =&gt; x)
.filter((x) =&gt; {
return (
x.id.indexOf(src) &gt;= 0 ||
(regex &amp;&amp; regex.<em><strong>test</strong></em>(x.id)) ||
(x.title &amp;&amp;
(x.title.indexOf(src) &gt;= 0 || (regex &amp;&amp; regex.<em><strong>test</strong></em>(x.title))))
);
})
.sort()
.map((x) =&gt; item(x));
//.join(&quot;\n&quot;)
setContent(rc(&quot;ol&quot;, null, res));
}, [src]);</p>
<p>return rc(
&quot;div&quot;,
{
className: &quot;custom-react-view&quot;,
},
[
rc(&quot;input&quot;, {
style: { width: &quot;100%&quot;, fontSize: &quot;1.2em&quot; },
value: src,
onChange: (e) =&gt; <em><strong>setS</strong></em>rc(e.target.value),
}),
content,
]
);
};</p>
<p>•••
•••&gt;search
G.*hUb
•••</p>
<h2 id="sync-localremoteorigin">Sync <code>local|remote|origin</code></h2>
<p>•••js #sync !collapse
// fetch all remote files and store
// locally if they don&#x27;t already exist</p>
<p>return (async fn =&gt; {
const t = Date.now()
const p = lit.utils.path
const writePLocal = async (...args) =&gt; {</p>
<p>}</p>
<p>const m = await fetch(&#x27;/manifest.json&#x27;)
.then(res =&gt; res.json())
.catch(e=&gt;({nodes:[]}))</p>
<p> const duds = []
const synced = []
const errors = []
const res = await Promise.all(m.nodes.map( async n =&gt; {
try {
n.stats = await lit.fs.readStat(n.id)
.then(x=&gt;x)
.catch(err=&gt;{
duds.push(n.id)
return {local: {}, remote: {}}
})</p>
<codecell class="local"><pre><code class="plaintext"></code></pre></codecell>
<p>} ))
console.log(<code>Synced ${synced.length}/${m.nodes.length} files in ${(Date.now() - t)/1000} seconds. Duds: ${duds.length} Errors: ${errors.length}</code>)
return {duds, errors}
})()</p>
<p>•••
•••&gt;txt attached=true updated=1621892351482
Synced 0/189 files in 0.407 seconds. Duds: 30 Errors: 2
{ duds:
[ &#x27;transfomers.lit&#x27;,
&#x27;custom-module.mjs&#x27;,
&#x27;log/checkforinput.js&#x27;,
&#x27;agora.lit&#x27;,
&#x27;components.lit&#x27;,
&#x27;rk.jsx&#x27;,
&#x27;viewers.lit&#x27;,
&#x27;litconfig.lit&#x27;,
&#x27;<em><strong>test</strong></em>ing/g<em><strong>etse</strong></em>rviceworker--sw&#x27;,
&#x27;fsviewer.jsx&#x27;,
&#x27;worker2.js&#x27;,
&#x27;wikilinks.lit&#x27;,
&#x27;.github/workflows/generate.yaml&#x27;,
&#x27;renderer/file.txt&#x27;,
&#x27;utils/urifragments.lit&#x27;,
&#x27;/<em><strong>test</strong></em>ing/log/2021-w22.lit&#x27;,
&#x27;worker.js&#x27;,
&#x27;meta/.github/workflows/npm-publish.yaml&#x27;,
&#x27;meta/files_and_links.lit&#x27;,
&#x27;viewers/meta.js&#x27;,
&#x27;utils/fs.lit&#x27;,
&#x27;distributed_knowledge_graph.lit&#x27;,
&#x27;markdown.lit&#x27;,
&#x27;runkit-repl-endpoint.js&#x27;,
&#x27;experimental_social_network.lit&#x27;,
&#x27;log/today.js&#x27;,
&#x27;filename&#x27;,
&#x27;remark.lit&#x27;,
&#x27;gitworker.js&#x27;,
&#x27;unified.lit&#x27; ],
errors:
[ &#x27;../scratch_pad.lit#viewers : Unable to normalize path - traverses above root directory&#x27;,
&#x27;../serviceworker.js : Unable to normalize path - traverses above root directory&#x27; ] }
•••
•••&gt;txt  updated=1621257192205
Synced 90/139 files in 0.616 seconds. Duds: 30 Errors: 7
{ duds:
[ &#x27;remark.lit&#x27;,
&#x27;viewers.lit&#x27;,
&#x27;.github/workflows/generate.yaml&#x27;,
&#x27;components.lit&#x27;,
&#x27;utils/urifragments.lit&#x27;,
&#x27;articles/ideas.lit&#x27;,
&#x27;executing_code_cells.lit&#x27;,
&#x27;./runkit-repl-endpoint.js&#x27;,
&#x27;transfomers.lit&#x27;,
&#x27;fsviewer.jsx&#x27;,
&#x27;viewers/meta.js&#x27;,
&#x27;filename&#x27;,
&#x27;worker.js&#x27;,
&#x27;worker2.js&#x27;,
&#x27;../../../../../<em><strong>test</strong></em>ing/log/2021-05.lit&#x27;,
&#x27;utils/fs.lit&#x27;,
&#x27;../../../../../<em><strong>test</strong></em>ing/log/2021.lit&#x27;,
&#x27;rk.jsx&#x27;,
&#x27;../../../../../<em><strong>test</strong></em>ing/log/2021-05&#x27;,
&#x27;wikilinks.lit&#x27;,
&#x27;unified.lit&#x27;,
&#x27;<em><strong>test</strong></em>ing/g<em><strong>etse</strong></em>rviceworker--sw&#x27;,
&#x27;meta/.github/workflows/npm-publish.yaml&#x27;,
&#x27;renderer/file.txt&#x27;,
&#x27;markdown.lit&#x27;,
&#x27;../../../../../<em><strong>test</strong></em>ing/log/year.lit&#x27;,
&#x27;log/today.js&#x27;,
&#x27;log/checkforinput.js&#x27;,
&#x27;litconfig.lit&#x27;,
&#x27;../../../../../<em><strong>test</strong></em>ing/log/2021&#x27; ],
errors:
[ &#x27;../scratch_pad.lit#viewers : Unable to normalize path - traverses above root directory&#x27;,
&#x27;../components/components.lit : Unable to normalize path - traverses above root directory&#x27;,
&#x27;../../../../../meta/<em><strong>sett</strong></em>ings.lit#plantuml-viewer--repl : Unable to normalize path - traverses above root directory&#x27;,
&#x27;../../../../../<em><strong>test</strong></em>ing/log/2021-w20.lit : Unable to normalize path - traverses above root directory&#x27;,
&#x27;../../../../../<em><strong>test</strong></em>ing/log/2021-05-12.lit : Unable to normalize path - traverses above root directory&#x27;,
&#x27;../utils/git-commit-all.js : Unable to normalize path - traverses above root directory&#x27;,
&#x27;../../../../../<em><strong>test</strong></em>ing/log/2021-w21.lit : Unable to normalize path - traverses above root directory&#x27; ] }
•••</p>
<h2 id="emergency-wipe-️">Emergency wipe ⚠️</h2>
<p>•••&gt;md !warn
Clicking on the following link will prompt you to confirm you want to wipe the local file system!
•••</p>
<p><a href="?__lfs_wipe=true">WIPE ⚠️<span class="linkIcon">§</span></a></p>
<ol>
<li>
<p><a href="/testing/isomorphic_git.html">/testing/isomorphic_git.lit</a></p>
<blockquote>
<p>/<em><strong>test</strong></em>ing/isomorphic_git.lit ... # Isomorphic Git</p>
</blockquote>
</li>
</ol>
<p>Since <code>.lit</code> already uses <a href="testing/lightningfs.html?file=testing/lightningfs.lit" title="***test***ing/LightningFS" wikilink="true">***test***ing/LightningFS</a> for the local filesystem we can easily use <a href="https://isomorphic-git.org/docs/en/quickstart">https://isomorphic-git.org/docs/en/quickstart<span class="linkIcon">↗</span></a> to manage versioning...</p>
<h2 id="table-of-contents-1">Table of Contents</h2>
<h2 id="initial-plan">Initial plan</h2>
<p>The initial plan is to just auto commit on all actions, enabling &quot;infinite&quot; undo.</p>
<p>Thereafter that may remain the default but ideally an ergonomic version of the raw git api can be exposed for more advanced users.</p>
<p><em>Implementation</em></p>
<p>•••js ../utils/git-commit-all.js !plugin type=fn id=git-commit-all !collapse
// initially, because it&#x27;s on every change
// a commit will mostly be for a single
// file at a time the immediate exception
// being when a file with output files
// is edited, in which case the commit
// includes those files.</p>
<p>export const fn = async () =&gt; {
const now = (new Date()).toISOString()</p>
<p>const fs = lit.lfs
const dir = lit.location.root
const git = lit.git
const FILE = 0, WORKDIR = 2, STAGE = 3</p>
<p>const unstaged = row =&gt; {
return row[WORKDIR] !== row[STAGE]
}</p>
<p>// get/list unstaged files
const status = await git.statusMatrix({ fs,dir})
const files = status
.filter( unstaged )
.map(row =&gt; row[FILE])</p>
<p>// stage everything
await git.add({fs, dir, filepath: &#x27;.&#x27;})</p>
<p>// message
const message = `Commit ${lit.location.src}</p>
<p>at ${now} includes the following ${files.length} files:
${files.map(f=&gt; &quot;- &quot; + f).join(&#x27;\n&#x27;)}`</p>
<p>// return message</p>
<p>// commit
const sha = await git.commit({fs, dir,
message,
author: {
name: &#x27;dotlitbot&#x27;,
email: &#x27;<a href="mailto:bot@dotlit.org">bot@dotlit.org</a>&#x27;
}
})
return <code>Committed ${sha.slice(0,6)}  ${message}</code>
}
•••
•••js !plugin id=git type=menu !collapse
export const menu = (ctx, {React, Menu}) =&gt; {
const rc = React.createElement
const commit = lit.file.data.plugins.fn[&#x27;git-commit-all&#x27;]
const onClick = async ev =&gt; alert(await commit())
return rc( Menu, {
title:&quot;Git&quot;,
disabled: false,
}, [rc(&#x27;span&#x27;, {onClick}, &#x27;Commit All&#x27;)])
}
•••
•••txt updated=1619425559711
Committed d738da
Auto commit <em><strong>test</strong></em>ing/isomorphic_git.lit</p>
<p>at: 2021-04-26T08:25:54.893Z
includes the following 2 files:</p>
<ul>
<li><em><strong>test</strong></em>ing/isomorphic_git.lit</li>
<li>utils/git-commit-all.js</li>
</ul>
<p>•••</p>
<h2 id="investigating-api">Investigating API</h2>
<p>•••js
return lit.fs
.readFile(&#x27;/.git/HEAD&#x27;, {
encoding: &#x27;utf8&#x27;
})
•••
•••&gt;txt attached=true updated=1621327741152
ref: refs/heads/master</p>
<p>•••
•••js
return (async () =&gt; {
return await lit.git.init({
fs: lit.lfs,
dir: lit.location.root
})
})()
•••
•••&gt;txt attached=true updated=1621327753489
undefined
•••</p>
<h3 id="status">Status</h3>
<p>•••js
return (async () =&gt; {
return lit.location.src + &quot; : &quot; + await lit.git.status({
fs: lit.lfs,
dir: lit.location.root,
filepath: &#x27;.&#x27;
})
})()
•••
•••&gt;txt attached=true updated=1621335274603
<em><strong>test</strong></em>ing/isomorphic_git.lit : *added
•••
•••js
return (async () =&gt; {
return await lit.git.statusMatrix({
fs: lit.lfs,
dir: lit.location.root,
filepaths: [&#x27;<em><strong>test</strong></em>ing/&#x27;]
})
})()
•••
•••&gt;txt attached=true updated=1621123831529
[ [ &#x27;&lt;&#x27;, 1, 0, 1 ],
[ &#x27;articles/ideas_for.lit&#x27;, 1, 1, 1 ],
[ &#x27;execute_code_cells.lit&#x27;, 1, 1, 1 ],
[ &#x27;index.lit&#x27;, 1, 1, 1 ],
[ &#x27;log/2021-05-11.lit&#x27;, 1, 1, 1 ],
[ &#x27;meta/<em><strong>sett</strong></em>ings.lit&#x27;, 1, 1, 1 ],
[ &#x27;parser/parser.lit&#x27;, 1, 1, 1 ],
[ &#x27;plugin_system.lit&#x27;, 1, 1, 1 ],
[ &#x27;renderer/renderer.lit&#x27;, 1, 1, 1 ],
[ &#x27;renderer/viewers&#x27;, 1, 0, 1 ],
[ &#x27;repls.lit&#x27;, 1, 1, 1 ],
[ &#x27;scratch_pad.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/input_buffer.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/isomorphic_git.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/lightningfs.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/log/2021-05-09.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/log/2021-05-11.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/log/2021-05-12.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/log/2021-05-13.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/log/2021-05-15.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/log/2021-w20.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/log/checkforinput.js&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/log/today.js&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/runkit-repl-endpoint.js&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/runkit.lit&#x27;, 1, 1, 1 ],
[ &#x27;<em><strong>test</strong></em>ing/serviceworker.lit&#x27;, 1, 1, 1 ],
[ &#x27;utils/momento.lit&#x27;, 1, 1, 1 ] ]
•••</p>
<p>•••js
const fs = lit.lfs
const dir = lit.location.root
const git = lit.git
const FILE = 0, WORKDIR = 2, STAGE = 3</p>
<p>// list files with unstaged changes
return (async () =&gt; {
const filenames = (await git.statusMatrix({ fs,dir}))
.filter(row =&gt; row[WORKDIR] !== row[STAGE])
.map(row =&gt; row[FILE])
return filenames
})()
•••
•••&gt;txt attached=true updated=1621123864584
[ &#x27;&lt;&#x27;, &#x27;renderer/viewers&#x27;, &#x27;<em><strong>test</strong></em>ing/isomorphic_git.lit&#x27; ]
•••</p>
<h3 id="add">Add</h3>
<p>•••js</p>
<p>const fs = lit.lfs
const dir = lit.location.root</p>
<p>return (async ()=&gt; {
return await lit.git.add({
fs,
dir,
filepath: &#x27;.&#x27;
})
})()
•••
•••&gt;txt attached=true updated=1621335127754
undefined
•••</p>
<h3 id="commit">Commit</h3>
<p>•••js</p>
<p>const fs = lit.lfs
const dir = lit.location.root</p>
<p>return (async ()=&gt; {
const now = (new Date()).toISOString()
let sha = await lit.git.commit({
fs,
dir,
message: <code>Auto commit (${now})</code>,
author: {
name: &#x27;dotlit&#x27;,
email: &#x27;<a href="mailto:bit@dotlit.org">bit@dotlit.org</a>&#x27;
}
})</p>
<p>console.log(sha)</p>
<p>})()
•••
•••&gt;txt attached=true updated=1619388707640
2c1dcf840173cd7c36aa1e5b96bc0922006de579
undefined
•••</p>
<h3 id="log">Log</h3>
<p>•••js &gt; text !collapse
const indentLines = str =&gt; str.split(&#x27;\n&#x27;).map( line =&gt; <code>      ${line}</code>).join(&#x27;\n&#x27;)</p>
<p>return (async ()=&gt; {
let commits = await lit.git.log({
fs: lit.lfs,
dir: lit.location.root,
depth: 10
})
return &quot;<strong>Log</strong>\n&quot; + commits.map( x =&gt; <code>1. **\</code>${x.oid.slice(0,6)}`**</p>
<p>${indentLines(x.commit.message)}`).join(&#x27;\n&#x27;)
})()
•••
•••&gt;text !collapse attached=true updated=1620129831107
<strong>Log</strong></p>
<ol>
<li>
<p><strong><code>d738da</code></strong></p>
<p>Auto commit <em><strong>test</strong></em>ing/isomorphic_git.lit</p>
<p>at: 2021-04-26T08:25:54.893Z
includes the following 2 files:</p>
<ul>
<li><em><strong>test</strong></em>ing/isomorphic_git.lit</li>
<li>utils/git-commit-all.js</li>
</ul>
</li>
<li>
<p><strong><code>498191</code></strong></p>
<p>Auto commit <em><strong>test</strong></em>ing/isomorphic_git.lit</p>
<p>at: 2021-04-26T08:16:04.689Z
includes the following 5 files:</p>
<ul>
<li>404.lit,- execute_code_cells.lit,- <em><strong>test</strong></em>ing/.gitignore,- <em><strong>test</strong></em>ing/isomorphic_git.lit,- <em><strong>test</strong></em>ing/lightningfs.lit</li>
</ul>
</li>
<li>
<p><strong><code>ef8bee</code></strong></p>
<p>Auto commit <em><strong>test</strong></em>ing/isomorphic_git.lit</p>
<p>at: 2021-04-25T23:25:46.517Z
includes the following 1 files:</p>
<ul>
<li><em><strong>test</strong></em>ing/isomorphic_git.lit</li>
</ul>
</li>
<li>
<p><strong><code>e146ec</code></strong></p>
<p>Auto commit <em><strong>test</strong></em>ing/isomorphic_git.lit</p>
<p>at: (2021-04-25T23:25:04.262Z)
includes the following 1 files:</p>
<ul>
<li><em><strong>test</strong></em>ing/isomorphic_git.lit</li>
</ul>
</li>
<li>
<p><strong><code>ccc6f8</code></strong></p>
<p>Auto commit <em><strong>test</strong></em>ing/isomorphic_git.lit
at: (2021-04-25T22:41:55.195Z)
includes the following tk files...</p>
</li>
<li>
<p><strong><code>d6a406</code></strong></p>
<p>Auto commit (2021-04-25T22:35:27.239Z)</p>
</li>
<li>
<p><strong><code>2c1dcf</code></strong></p>
<p>Auto commit (2021-04-25T22:11:46.433Z)</p>
</li>
<li>
<p><strong><code>769349</code></strong></p>
<p>Auto commit (${now})</p>
</li>
<li>
<p><strong><code>74737c</code></strong></p>
<p>Commit All!!!</p>
</li>
<li>
<p><strong><code>a90dc6</code></strong></p>
<p>Commit All!!!</p>
</li>
</ol>
<p>•••</p>
<h3 id="diff">Diff</h3>
<p>•••js
const {git, lfs} = lit
return [git.walk, git.TREE]
•••
•••&gt;txt attached=true updated=1620405199415
[ [Function: walk], [Function: TREE] ]
•••
•••js !collapse
return lit.git
const commitHash1 = &#x27;0c40ed746ebe53cf744d78191d0bbc2941537280&#x27;
const commitHash2 = &#x27;b081f51cd27f54cf58915512006838d4eb67716b&#x27;
const git = lit.git
return git.walk({
lit.lfs,
lit.location.root,
trees: [git.TREE({ ref: commitHash1 }), git.TREE({ ref: commitHash2 })],
map: async function(filepath, [A, B]) {
 return filepath
})
)}
•••
•••&gt;txt attached=true updated=1620405076140 !error
undefined
•••</p>
<h2 id="http-client">Http client</h2>
<p>•••js</p>
<p>return (async fn =&gt;{
const http = await import(&#x27;<a href="https://unpkg.com/isomorphic-git/http/web/index.js">https://unpkg.com/isomorphic-git/http/web/index.js<span class="linkIcon">↗</span></a>&#x27;)
return lit.git.getRemoteInfo({ http: http.default, url: &#x27;<a href="https://github.com/isomorphic-git/isomorphic-git">https://github.com/isomorphic-git/isomorphic-git<span class="linkIcon">↗</span></a>&#x27; })
})()</p>
<p>•••
•••&gt;txt attached=true updated=1621336307318
undefined
•••</p>
<h2 id="web-worker">Web worker</h2>
<p>•••&gt;js gitworker.js
/* eslint-env worker <em>/
/</em> globals LightningFS git MagicPortal GitHttp */
importScripts(
&quot;<a href="https://unpkg.com/@isomorphic-git/lightning-fs">https://unpkg.com/@isomorphic-git/lightning-fs<span class="linkIcon">↗</span></a>&quot;,
&quot;<a href="https://unpkg.com/isomorphic-git@beta">https://unpkg.com/isomorphic-git@beta<span class="linkIcon">↗</span></a>&quot;,
&quot;<a href="https://unpkg.com/isomorphic-git@beta/http/web/index.umd.js">https://unpkg.com/isomorphic-git@beta/http/web/index.umd.js<span class="linkIcon">↗</span></a>&quot;,
&quot;<a href="https://unpkg.com/magic-portal">https://unpkg.com/magic-portal<span class="linkIcon">↗</span></a>&quot;
);</p>
<p>let fs = new LightningFS(&quot;fs&quot;, { wipe: true });
const portal = new MagicPortal(self);
self.addEventListener(&quot;message&quot;, ({ data }) =&gt; console.log(data));</p>
<p>(async () =&gt; {
let mainThread = await portal.get(&quot;mainThread&quot;);
let dir = &quot;/&quot;;
portal.set(&quot;workerThread&quot;, {
setDir: async _dir =&gt; {
dir = _dir;
},
clone: async args =&gt; {
fs = new LightningFS(&quot;fs&quot;, { wipe: true });
try{
return git.clone({
...args,
fs,
http: GitHttp,
dir,
onProgress(evt) {
mainThread.progress(evt);
},
onMessage(msg) {
mainThread.print(msg);
},
onAuth(url) {
console.log(url);
return mainThread.fill(url);
},
onAuthFailure({ url, auth }) {
return mainThread.rejected({ url, auth });
}
});
} catch(err) {
mainThread.failure({message}=err)
}
},
listBranches: args =&gt; git.listBranches({ ...args, fs, dir }),
listFiles: args =&gt; git.listFiles({ ...args, fs, dir }),
log: args =&gt; git.log({ ...args, fs, dir })
});
})();
•••</p>
<p>•••html #reference !collapse</p>
<p>•••</p>
<p>•••lit !collapse #template &lt; log/day.lit</p>
<p>•••
•••js !plugin !collapse type=viewer of=bookmarklet
export const viewer = ({ node, React }) =&gt; {
const rc = React.createElement;
const meta = node.properties.meta;
const href = <code>javascript:(function(){${node.data.value}})()</code>;
return rc(&quot;span&quot;, null, [
&quot;Bookmarklet: &quot;,
rc(&quot;a&quot;, { href: href }, <code>Run ${meta &amp;&amp; meta.id ? meta.id : &quot;bookmarklet&quot;}</code>),
&quot; href: &quot;,
rc(&quot;pre&quot;, null, rc(&quot;code&quot;, null, href)),
]);
};</p>
<p>•••</p>
<ol>
<li>
<p><a href="/testing/local_remote_files.html">/testing/local_remote_files.lit</a></p>
<blockquote>
<p>/<em><strong>test</strong></em>ing/local_remote_files.lit ... # Local and Remote files</p>
</blockquote>
</li>
</ol>
<p>On load <code>.lit</code> determines the <code>src</code> and <code>root</code> and checks both local file system (<a href="testing/lightningfs.html?file=testing/lightningfs.lit" title="***test***ing/LightningFS" wikilink="true">***test***ing/LightningFS</a>) and the remote host (ie GitHub pages, or local/remote server) and compares <code>last-updated</code> (or Stat <code>mtimeMs</code> in the case of local filesystem)</p>
<p>The problem is, that deployment to GitHub pages results in a remote file that <em>seems</em> newer than the local file that created it.</p>
<h2 id="potential-solutions">Potential solutions</h2>
<ul>
<li>
<p>Disable (appropriately) GitHub Pages cache</p>
<p><a href="https://stackoverflow.com/questions/12556593/determining-a-page-is-outdated-on-github-pages">https://stackoverflow.com/questions/12556593/determining-a-page-is-outdated-on-github-pages<span class="linkIcon">↗</span></a></p>
</li>
<li>
<p>Read from api instead of pages static file server when Authenticated</p>
<ul class="contains-task-list">
<li>Potentially read and write to <code>gh-pages</code> directly, eschewing Actions deployment entirely.</li>
<li class="task-list-item"><input type="checkbox" checked="" disabled=""/> <!-- -->Currently reading and writing to GitHub api when token is available. <strong>Breaks reading generated files like : manifest.json</strong></li>
</ul>
</li>
<li>
<p>Compare hashes of the content <a href="https://stackoverflow.com/questions/18338890/are-there-any-sha-256-javascript-implementations-that-are-generally-considered-t/48161723#48161723">stackoverflow crypto<span class="linkIcon">↗</span></a></p>
</li>
</ul>
<p>•••txt <em><strong>test</strong></em>.txt remote=true &lt; <em><strong>test</strong></em>.txt
Q
•••
•••js
return lit.fs.readFile(&#x27;/manifest.json&#x27;)
•••</p>
<ol>
<li>
<p><a href="/testing/autoformatting_cell_source.html">/testing/autoformatting_cell_source.lit</a></p>
<blockquote>
<p>/<em><strong>test</strong></em>ing/autoformatting_cell_source.lit ... # Autoformatting Cell Source</p>
</blockquote>
</li>
</ol>
<h2 id="-with-prettier">... with prettier</h2>
<p>Homepage <a href="https://prettier.io">https://prettier.io<span class="linkIcon">↗</span></a></p>
<p>•••js babel=true #reference
import prettier from &quot;<a href="https://unpkg.com/prettier@2.3.0/esm/standalone.mjs">https://unpkg.com/prettier@2.3.0/esm/standalone.mjs<span class="linkIcon">↗</span></a>&quot;;
import parserBabel from &quot;<a href="https://unpkg.com/prettier@2.3.0/esm/parser-babel.mjs">https://unpkg.com/prettier@2.3.0/esm/parser-babel.mjs<span class="linkIcon">↗</span></a>&quot;;</p>
<p>console.log(
prettier.format(&quot;const html=/* HTML */ <code>&lt;DIV&gt; &lt;/DIV&gt;</code>&quot;, {
parser: &quot;babel&quot;,
plugins: [parserBabel],
})
);</p>
<p>•••</p>
<p>•••js #<em><strong>test</strong></em> &gt; js #formatted
return (async fn =&gt; { // intentionally [sic] badly formatted
const p = await import(</p>
<p>&#x27;<a href="https://unpkg.com/prettier@2.3.0/esm/standalone.mjs">https://unpkg.com/prettier@2.3.0/esm/standalone.mjs<span class="linkIcon">↗</span></a>&#x27;)</p>
<codecell class="local"><pre><code class="plaintext"></code></pre></codecell>
<p>const format
= p.default.format
const babelPlugin
= b.default</p>
<p>const thisCellsSource = this.children[0].children[0].data.value</p>
<p>return format(thisCellsSource, { parser: &quot;babel&quot;,plugins: [babelPlugin]})
})()
•••
•••&gt;js #formatted attached=true updated=1621285984079
return (async (fn) =&gt; {
// intentionally [sic] badly formatted
const p = await import(&quot;<a href="https://unpkg.com/prettier@2.3.0/esm/standalone.mjs">https://unpkg.com/prettier@2.3.0/esm/standalone.mjs<span class="linkIcon">↗</span></a>&quot;);</p>
<p>const b = await import(
&quot;<a href="https://unpkg.com/prettier@2.3.0/esm/parser-babel.mjs">https://unpkg.com/prettier@2.3.0/esm/parser-babel.mjs<span class="linkIcon">↗</span></a>&quot;
);
const format = p.default.format;
const babelPlugin = b.default;</p>
<p>const thisCellsSource = this.children[0].children[0].data.value;</p>
<p>return format(thisCellsSource, { parser: &quot;babel&quot;, plugins: [babelPlugin] });
})();</p>
<p>•••</p>
<p>Implementing as a transformer <code>!plugin</code></p>
<p>•••&gt;js ../plugins/transformers/prettier.js !plugin type=transformer of=prettier id=prettier
export const transformer = async ({
node,
src,
codeSource,
rawSource,
originalSource,
}) =&gt; {
const lines = src.split(&quot;\n&quot;);
let [first, ...rest] = lines;
let middle = rest.slice(0, -1);
const [last] = rest.slice(-1);
const body = middle.join(&quot;\n&quot;);</p>
<p>const p = await import(&quot;<a href="https://unpkg.com/prettier@2.3.0/esm/standalone.mjs">https://unpkg.com/prettier@2.3.0/esm/standalone.mjs<span class="linkIcon">↗</span></a>&quot;);
const b = await import(
&quot;<a href="https://unpkg.com/prettier@2.3.0/esm/parser-babel.mjs">https://unpkg.com/prettier@2.3.0/esm/parser-babel.mjs<span class="linkIcon">↗</span></a>&quot;
);</p>
<p>const format = p.default.format;
const babelPlugin = b.default;
try {
return [
first,
format(body, { parser: &quot;babel&quot;, plugins: [babelPlugin] }),
last,
].join(&quot;\n&quot;);
} catch (err) {
lit.file.message(err.message);
return src;
}
};</p>
<p>•••</p>
<p>•••js transformer=prettier
// make me
// prettier
//...
// thanks</p>
<p>return async fn=&gt;{}</p>
<p>•••</p>
<p>edit and save the above cell to have it automatically formatted by Prettier using the transformer <code>!plugin</code> implemented above.</p>
<ol>
<li>
<p><a href="/testing/runkit.html">/testing/runkit.lit</a></p>
<blockquote>
<p>/<em><strong>test</strong></em>ing/runkit.lit ... # <em><strong>test</strong></em>ing/runkit.lit</p>
</blockquote>
</li>
</ol>
<p>Experimenting using <a href="https://runkit.com">RunKit<span class="linkIcon">↗</span></a> as a custom repl for nodejs. Warning, it starts off messy, but in the end we have a reusable <code>nodejs</code> custom REPL.</p>
<h2 id="table-of-contents-2">Table of Contents</h2>
<h2 id="embed">Embed</h2>
<p>Lets start with just the simple <a href="https://runkit.com/docs/embed">demo embed,<span class="linkIcon">↗</span></a> adding the embed script and a container below.</p>
<p>•••script <a href="https://embed.runkit.com">https://embed.runkit.com<span class="linkIcon">↗</span></a> !inline
// injecting <a href="https://embed.runkit.com">https://embed.runkit.com<span class="linkIcon">↗</span></a> script
•••</p>
<p>•••html !inline</p>
<p>Run the #init cell below 👇 to populate it With some demo source.</p>
<p>•••js #init !collapse
return RunKit.createNotebook({
// the parent element for the new notebook
element: document.getElementById(&quot;my-element&quot;),
onEvaluate: (...args) =&gt; alert(JSON.stringify([...args])),
// specify the source of the notebook
source: &quot;// GeoJSON!\nvar getJSON = require(&quot;async-get-json&quot;);\n\nawait getJSON(&quot;<a href="https://storage.googleapis.com/maps-devrel/google.json%5C">https://storage.googleapis.com/maps-devrel/google.json\<span class="linkIcon">↗</span></a>&quot;);&quot;
})
•••</p>
<h2 id="endpoint">Endpoint</h2>
<p>react bindings for simple embed: <a href="https://github.com/runkitdev/react-runkit">https://github.com/runkitdev/react-runkit<span class="linkIcon">↗</span></a> and trying out <a href="https://runkit.com/docs/endpoint">https://runkit.com/docs/endpoint<span class="linkIcon">↗</span></a></p>
<p>•••jsx babel=true react=true repl=js !below #react #endpoint
return (async fn =&gt; {</p>
<p>const React = lit.utils.React
const Embed = (await import(&#x27;<a href="https://cdn.skypack.dev/runkit-embed-react&#x27;">https://cdn.skypack.dev/runkit-embed-react&#x27;<span class="linkIcon">↗</span></a>)).default</p>
<p>const createdAt = new Date()</p>
<p>const helloSource = <code>exports.endpoint = function(request, response) {     response.end(&quot;Hello world! From .lit and Nodejs thanks to RunKit. Created at &quot; + createdAt); }</code></p>
<p>const onLoad = (...args) =&gt; console.log(JSON.stringify([...args]))</p>
<p>return &lt;Embed
mode=&#x27;endpoint&#x27;
readOnly={true}
evaluateOnLoad={true}
// hidesActionButton={true}
source={ helloSource }
// ref=&#x27;embed&#x27;
onLoad={ onLoad }
/&gt;</p>
<p>})()
•••</p>
<p>•••uri !below
<a href="https://2mkz0r1anfrl.runkit.sh/">https://2mkz0r1anfrl.runkit.sh/<span class="linkIcon">↗</span></a>
•••</p>
<h2 id="viewer-plug-in">Viewer plug-in</h2>
<p>•••jsx rk.jsx !collapse !plugin type=viewer of=runkit
import Embed from &#x27;<a href="https://cdn.skypack.dev/runkit-embed-react">https://cdn.skypack.dev/runkit-embed-react<span class="linkIcon">↗</span></a>&#x27;</p>
<p>export const viewer = ({node,React}) =&gt; {
const {u<em><strong>seSt</strong></em>ate} = React
const [url, setUrl] = u<em><strong>seSt</strong></em>ate(false)
const meta = node?.properties?.meta || {}
const endpoint = meta.attrs &amp;&amp; meta.attrs.mode === &#x27;endpoint&#x27;</p>
<p>const onLoad = async (rk) =&gt; {
if (endpoint)
setUrl(await rk.getEndpointURL())
}</p>
<p>return url || &lt;Embed
mode={endpoint ? &#x27;endpoint&#x27; : &#x27;default&#x27;}
readOnly={endpoint}
evaluateOnLoad={endpoint}
hidesActionButton={endpoint}
source={ node.data.value }
// ref=&#x27;embed&#x27;
onLoad={ onLoad }
/&gt;</p>
<p>}
•••</p>
<p>•••runkit !inline
console.log(&quot;Hello world! From .lit and Nodejs thanks to RunKit.&quot;)
•••
•••runkit !below mode=endpoint
exports.endpoint = function(req, res) {
res.end(&quot;Hello world! From .lit and Nodejs thanks to RunKit.&quot;);
}
•••<code> •••runkit !below mode=endpoint exports.endpoint = function(req,res) {   res.writeHead(200, {     &#x27;Content-Type&#x27;: &#x27;application/json&#x27;,     &#x27;Access-Control-Allow-Origin&#x27;: &#x27;*&#x27;,     &#x27;Access-Control-Allow-Methods&#x27;: &#x27;*&#x27;,   });   res.end(&#x27;{&quot;ping&quot;: &quot;pong!&quot;}&#x27;) } •••</code></p>
<p>•••js
return fetch(&quot;<a href="https://jzc0q8a4nyog.runkit.sh%22).then(res">https://jzc0q8a4nyog.runkit.sh&quot;).then(res<span class="linkIcon">↗</span></a> =&gt; res.text())
•••
•••&gt;txt attached=true updated=1621030315807
{&quot;ping&quot;: &quot;pong!&quot;}
•••</p>
<h2 id="repl-endpoint-plug-in-node">REPL endpoint plug-in <code>node</code></h2>
<p>Split out the endpoint source to its own <code>.lit</code> cell for legibility instead of an inline string.</p>
<p>•••&gt;js runkit-repl-endpoint.js !collapse #source
const util = require(&#x27;util&#x27;)</p>
<p>function requireFromString(src, filename) {
var Module = module.constructor;
var m = new Module();
m._compile(src, filename);
return m.exports;
}</p>
<p>exports.endpoint = function(req,res) {
res.writeHead(200, {
&#x27;Content-Type&#x27;: &#x27;application/json&#x27;,
&#x27;Access-Control-Allow-Origin&#x27;: &#x27;<em>&#x27;,
&#x27;Access-Control-Allow-Methods&#x27;: &#x27;</em>&#x27;,
});</p>
<p>let data = &#x27;&#x27;;
req.on(&#x27;data&#x27;, chunk =&gt; {
data += chunk;
})</p>
<p>req.on(&#x27;end&#x27;, async () =&gt; {
const payload = JSON.parse(data)
const exported = requireFromString(payload.src, payload.meta.filename || &quot;untitled.js&quot;)
let result;
if (typeof exported === &#x27;function&#x27;) {
try {
result = await exported(payload.meta)
res.end(util.inspect({
result
}))
} catch(error) {
res.end(util.inspect({error}))
}
} else {
res.end(util.inspect({
exports: exported
}))
}
})
}
•••</p>
<p>On load the following <code>repl</code> <code>!plugin</code> creates a RunKit endpoint if it doesn&#x27;t exist using the above source.</p>
<p>•••js !plugin type=repl of=node !collapse
if (typeof lit !== &#x27;undefined&#x27; &amp;&amp; !window.__runkitNodeEnpoint) {
(async fn =&gt; {
const el = document.createElement(&#x27;div&#x27;)
document.body.appendChild(el)
// el.setAttribute(&quot;style&quot;, &quot;height:0;&quot;)
RunKit.createNotebook({
element: el,
mode: &#x27;endpoint&#x27;,
onLoad: async (rk) =&gt; {
window.__runkitNodeEnpoint = await rk.getEndpointURL()
// document.body.removeChild(el)
},
evaluateOnLoad: true,
source: await lit.fs.readFile(&quot;<em><strong>test</strong></em>ing/runkit-repl-endpoint.js&quot;, {encoding: &#x27;utf8&#x27;})
})
})()
}</p>
<p>export const repl = async (src, meta, node) =&gt; {
if (!window.__runkitNodeEnpoint) {
return &quot;Still <em><strong>sett</strong></em>ing up repl endpoint&quot;
} else {
try {
return await (await fetch(window.__runkitNodeEnpoint, {
method: &quot;POST&quot;,
body: JSON.stringify({src,meta})
})).text()
} catch(err) {
return err.message
}
}
}
•••</p>
<p><em>Usage:</em>
•••js <em><strong>test</strong></em>.js repl=node
module.exports = async (meta) =&gt; {
return <code>Hello world! From .lit and Nodejs ${process.env.NODE_VERSION} (${process.platform} ${process.arch}) thanks to RunKit. At ${new Date()}</code>
}
•••
•••&gt;txt attached=true updated=1621287964690
{ result:
&#x27;Hello world! From .lit and Nodejs 10.24.1 (linux x64) thanks to RunKit. At Mon May 17 2021 21:46:04 GMT+0000 (Coordinated Universal Time)&#x27; }
•••
•••&gt;txt  updated=1621086966109
{ result:
&#x27;Hello world! From .lit and Nodejs 10.24.1 (linux x64) thanks to RunKit. At Sat May 15 2021 13:56:05 GMT+0000 (Coordinated Universal Time)&#x27; }
•••</p>
<h2 id="next-steps-and-improvements">Next steps and improvements</h2>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->Don&#x27;t start the endpoint on every page load, and instead lazily setup just before first execution.</li>
<li class="task-list-item"><input type="checkbox" disabled=""/> <!-- -->Don&#x27;t use require module from string hack, and instead use a proper <code>vm</code> abd context.</li>
</ul>
<ol>
<li>
<p><a href="/testing/compact_manifest.html">/testing/compact_manifest.lit</a></p>
<blockquote>
<p>/<em><strong>test</strong></em>ing/compact_manifest.lit ... # Compact Manifest</p>
</blockquote>
</li>
</ol>
<p>Reducing the serialised size of a manifest of all files in a <code>.lit</code> notebook.</p>
<h2 id="trying-out-compact-prefix-tree">Trying out <a href="https://github.com/sidvishnoi/compact-prefix-tree">compact-prefix-tree<span class="linkIcon">↗</span></a></h2>
<p>•••js
return (async fn =&gt; {
const {CompactPrefixTree} = await import(&#x27;<a href="https://cdn.skypack.dev/compact-prefix-tree">https://cdn.skypack.dev/compact-prefix-tree<span class="linkIcon">↗</span></a>&#x27;)</p>
<p>const manifest = await fetch(&#x27;/manifest.json&#x27;).then(res =&gt; res.json())
const keys = manifest.nodes.map(n=&gt;n.id)
const trie = new CompactPrefixTree(keys)</p>
<p>const before = JSON.stringify(keys)
const after = JSON.stringify(trie.T)
// console.log(trie.T)
await lit.fs.writeFile(&#x27;/<em><strong>test</strong></em>ing/compactManifest1.json&#x27;, after, &#x27;utf8&#x27;)
return <code>A ${after.length/before.length*100}% reduction in size.</code>
})()
•••
•••&gt;txt attached=true updated=1621379712347
A 91.78470254957507% reduction in size.
•••</p>
<p>Looking up a file, check for existence:
•••js
return (async (fn) =&gt; {
const { CompactPrefixTree, getWordsFromTrie } = await import(
&quot;<a href="https://cdn.skypack.dev/compact-prefix-tree">https://cdn.skypack.dev/compact-prefix-tree<span class="linkIcon">↗</span></a>&quot;
);</p>
<p>const json = await fetch(&quot;/<em><strong>test</strong></em>ing/compactManifest1.json&quot;).then((res) =&gt;
res.json()
);
// return json
const keys = getWordsFromTrie(json);
const trie = new CompactPrefixTree(Array.from(keys));
return trie.prefix(&quot;<em><strong>test</strong></em>ing/log/&quot;);
})();</p>
<p>•••
•••&gt;txt  updated=1621380328935
{ prefix: &#x27;<em><strong>test</strong></em>ing/log/day.lit&#x27;, isProper: true }
•••
•••&gt;txt updated=1621380061074
{ prefix: &#x27;&#x27;, isProper: false }
•••</p>
</div></codecell></div></cell><cell startpos="2835:1-76497" endpos="2853:4-77420" class="code output"><div class="cell-content"><codecell class="lang-md local output"><span class="meta"><span class="lang">md</span><span class="updatedAt">Updated <span class="Time relative">6.8h ago</span></span></span><div class="md-block">
<p>Results for search &quot;<strong>fuzz</strong>&quot;. In <strong>0.074</strong> seconds.</p>
<ol>
<li><a href="/testing/fuzzy_text_search.html">/testing/fuzzy_text_search.lit</a> 0.000001</li>
<li><a href="/testing/log/2021-05-23.html">/testing/log/2021-05-23.lit</a> 0.001</li>
<li><a href="/functions.html">/functions.lit</a> 0.25</li>
<li><a href="/testing/input_buffer.html">/testing/input_buffer.lit</a> 0.25</li>
<li><a href="/testing/full.json">/testing/full.json</a> 0.5</li>
<li><a href="/utils/functions.js">/utils/functions.js</a> 0.5</li>
<li><a href="/index.html">/index.lit</a> 0.5</li>
<li><a href="/execute_code_cells.html">/execute_code_cells.lit</a> 0.5</li>
<li><a href="/plugin_system.html">/plugin_system.lit</a> 0.5</li>
<li><a href="/scratch_pad.html">/scratch_pad.lit</a> 0.5</li>
<li><a href="/prismjs_and_a_simple_editor.html">/prismjs_and_a_simple_editor.lit</a> 0.5</li>
<li><a href="/testing/lightningfs.html">/testing/lightningfs.lit</a> 0.5</li>
<li><a href="/testing/isomorphic_git.html">/testing/isomorphic_git.lit</a> 0.5</li>
<li><a href="/testing/runkit.html">/testing/runkit.lit</a> 0.5</li>
<li><a href="/testing/selection.html">/testing/selection.lit</a> 0.5</li>
</ol>
</div></codecell></div></cell></section></section>
<section depth="2" class="" startpos="2859:1-77426" endpos="2876:4-77793"><cell startpos="2859:1-77426" endpos="2861:38-77476"><div class="cell-content"><h2 id="fuzzyset">FuzzySet</h2><p><a href="https://github.com/Glench/fuzzyset.js">https://github.com/Glench/fuzzyset.js<span class="linkIcon">↗</span></a></p></div></cell><cell startpos="2863:1-77478" endpos="2876:4-77793" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">return import(&#x27;https://cdn.skypack.dev/fuzzyset&#x27;).then( FuzzySet =&gt; {

  const f = new FuzzySet.default()
  f.add(&quot;the text of mine&quot;)
  f.add(&quot;the text of someone else&quot;)
  f.add(&quot;other texts&quot;)
  return f.get(&quot;text of&quot;)
})

</code></pre></codecell><codecell class="lang-txt local output"><span class="meta"><span class="lang">txt</span><span class="updatedAt">Updated <span class="Time relative">1.3d ago</span></span></span><output><pre><code class="txt">[ [ 0.4375, &#x27;the text of mine&#x27; ] ]
</code></pre></output></codecell></div></cell></section></div></div><div id="backlinks"><h4>Backlinks (1)</h4><ol><li><a title="2021-05-23" href="/testing/log/2021-05-23.html">2021-05-23</a></li></ol></div><script src="//cdn.jsdelivr.net/npm/eruda"></script><script>eruda.init();</script><script async="" src="/web.bundle.js"></script></body></html>