<html data-reactroot=""><head><title>Persist to GitHub</title><meta name="litsrc" value="/persist_to_github.lit"/><meta name="litroot" value="/"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><meta name="apple-mobile-web-app-capable" content="yes"/><link rel="apple-touch-icon" href="/assets/lit-logo.png"/><link rel="icon" href="/assets/lit-logo.png"/><link rel="stylesheet" href="/style.css"/></head><body><div id="lit-app"><div id="lit-header"><menu class="horizontal open has-children"><li class="MenuTitle"><a href="/">Home</a></li><li class="MenuItems"><menu class="has-children" disabled=""><li class="MenuTitle">File</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Cell</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Section</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Help</li></menu><menu class="has-children right"><li class="MenuTitle"><span class="led led-grey"></span><span class="led led-grey"></span><span class="led led-grey"></span></li></menu></li></menu></div><style>body {
  --bg: red;
  --bg-secondary-color: #efefef;
    
  --text-color: black;
  --text-secondary-color: grey;
  --text-primary-color: #9999f7;
  --text-highlight-bg: yellow;
  --text-highlight-color: black;

  --divider-subtle: #efefef;
  --medium-space: 0.4em;
  --code-bg-color: black;
  --code-text-color: white;
  --box-bg-opacity: 0.05;
}</style><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.0.0/build/styles/sunburst.min.css"/><div id="content"><section id="persist-to-github" depth="1" class="" startpos="1:1-0" endpos="9:4-282"><div startpos="1:1-0" endpos="5:50-212" class="cell"><div class="cell-content"><h1>Persist to GitHub</h1><p>See <a class="local" href="config.html#github" filepath="/persist_to_github.lit" root="" data="[object Object]">config#github</a> to configure which respository to connect to, and provide a GitHub access token for authentication.</p><p>Then, thanks to the below, it should just-work™️.</p></div></div><div startpos="7:1-214" endpos="9:4-282" class="code   cell"><div class="cell-content"><div class="dir-collapse tag-implementation lang-js local collapsed codecell"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span style="color:white;background-color:#6455ab" class="tag">implementation</span><span class="source">&lt; utils/fs-promises-gh-utils.js</span></span><pre><code class="js">import { b64EncodeUnicode, b64DecodeUnicode } from &#x27;./safe-encoders&#x27;
import { getConsoleForNamespace } from &#x27;./console&#x27;
import {join} from &#x27;path&#x27;

const console = getConsoleForNamespace(&#x27;fs/gh&#x27;)

const getEndpoint = (opts,file) =&gt; `https://api.github.com/repos/${opts.username}/${opts.repository}/${join(&#x27;contents&#x27;, file)}`

export const ghReadFile = opts =&gt; async (...args) =&gt; {
    const file = join(opts.prefix,args[0])
    const params = {
        method: &quot;GET&quot;,
        headers: {
            &quot;Authorization&quot;: `token ${opts.token}`,
            &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
        },
    }
    const resp = await fetch(getEndpoint(opts,file), params)
    // resp.origJson = resp.json
    resp.text = async () =&gt; {
        console.log(&quot;ghReadFile text()...&quot;)
        const data = await resp.json()
        console.log(&quot;ghReadFile data&quot;, data)
        const content = b64DecodeUnicode(data.content)
        console.log(&quot;ghReadFile decoded&quot;)
        return content
    }
    console.log(&quot;ghReadFile&quot;, file, resp)
    return resp
}

export const ghWriteFile = (opts) =&gt; async (...args) =&gt; {
    const file = join(opts.prefix,args[0])
    const content = args[1].toString()
    console.log(&quot;ghWriteFile&quot;, file)
    const endpoint = getEndpoint(opts, file)
    const resp1 = await fetch(endpoint, {
        method: &quot;GET&quot;,
        headers: {
            &quot;Authorization&quot;: `token ${opts.token}`,
            &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
        }
    })
    const json1 = await resp1.json()
    console.log(endpoint, json1.sha ? &quot;Exists, updating...&quot;:&quot;Dosn&#x27;t exist, creating...&quot;)
    const params = {
        method: &quot;PUT&quot;,
        headers: {
            &quot;Authorization&quot;: `token ${opts.token}`,
            &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
        },
        body: JSON.stringify({
            sha: json1.sha,
            message: opts.commitMessage || `Edited ${file}`,
            content: b64EncodeUnicode(content)
        })
    }
    console.log(&quot;ghWriteFile params&quot;, params)
    let resp2;
    try {
      resp2 = await fetch(endpoint, params)
    } catch(err) {
      console.log(&quot;ghWriteFile PUT failed&quot;, err)
    }
    return resp2 &amp;&amp; resp2.status
}

export const ghDeleteFile = opts =&gt; async (...args) =&gt; {
    const file = join(opts.prefix,args[0])
    console.log(&quot;ghDeleteFile&quot;, file)
    const endpoint = getEndpoint(opts, file)
    const resp1 = await fetch(endpoint)
    const json1 = await resp1.json()
    console.log(endpoint, json1.sha ? &quot;Exists, deleting...&quot;:&quot;Dosn&#x27;t exist&quot;)
    const params = {
        method: &quot;DELETE&quot;,
        headers: {
            &quot;Authorization&quot;: `token ${opts.token}`,
            &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
        },
        body: JSON.stringify({
            sha: json1.sha,
            message: opts.commitMessage || `Deleted ${file}`,
        })
    }
    console.log(&quot;ghDeleteFile params&quot;, params)
    let resp2;
    try {
      resp2 = await fetch(endpoint, params)
      const json = await resp2.json()
      console.log(&quot;ghDeleteFile DELETE response&quot;, resp2, json)
    } catch(err) {
      console.log(&quot;ghDeleteFile DELETE failed&quot;, err.message, err)
    }
    return resp2 &amp;&amp; resp2.status
}

</code></pre></div></div></div></section></div></div><div id="backlinks"><h4>Backlinks (1)</h4><ol><li><a title=".lit Filesystem" href="/filesystem/index.html">.lit Filesystem</a></li></ol></div><script src="//cdn.jsdelivr.net/npm/eruda"></script><script>eruda.init();</script><script async="" src="/web.bundle.js"></script></body></html>