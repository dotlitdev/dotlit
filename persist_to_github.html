<html data-reactroot=""><head><title>Persist to GitHub</title><meta name="litsrc" value="persist_to_github.lit"/><meta name="litroot" value="/"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/railscasts.css"/><link rel="stylesheet" href="/style.css"/></head><body><div id="lit-app"><div id="lit-header"><menu class="horizontal open has-children"><li class="MenuTitle"><a href="/">Home</a></li><li class="MenuItems"><menu class="has-children"><li class="MenuTitle">File</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Cell</li></menu><menu class="has-children" disabled=""><li class="MenuTitle">Section</li></menu><menu class="has-children"><li class="MenuTitle">Help</li></menu><menu class="has-children right"><li class="MenuTitle"><span class="led led-grey"></span></li></menu></li></menu><div class="lit-messages"></div></div><div id="content"><section depth="1" class="" startpos="1:1-0" endpos="18:4-357"><cell startpos="1:1-0" endpos="5:24-123"><div class="cell-content"><h1 id="persist-to-github">Persist to GitHub</h1><p>Assuming you generate a personal access token and store it in <code>localStorage</code>.</p><p>See Help &gt; GitHub Token</p></div></cell><cell startpos="7:1-125" endpos="9:4-180" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">localStorage.setItem(&#x27;ghToken&#x27;, &#x27;YOUR_TOKEN&#x27;)
</code></pre></codecell></div></cell><cell startpos="11:1-182" endpos="11:50-231"><div class="cell-content"><p>Then, thanks to the below, it should just-work™️.</p></div></cell><cell startpos="13:1-233" endpos="15:4-301" class="code"><div class="cell-content"><codecell class="dir-collapse tag-implementation lang-js local collapsed"><span class="meta"><span class="lang">js</span><span style="color:black;background-color:#da5323" class="directive dir-collapse">collapse</span><span style="color:white;background-color:#6455ab" class="tag">implementation</span><span class="source">&lt; utils/fs-promises-gh-utils.js</span></span><pre><code class="js">import { b64EncodeUnicode, b64DecodeUnicode } from &#x27;./safe-encoders&#x27;
import { getConsoleForNamespace } from &#x27;./console&#x27;

const console = getConsoleForNamespace(&#x27;fs/gh&#x27;)

const getEndpoint = (opts,file) =&gt; `https://api.github.com/repos/${opts.username}/${opts.repository}/contents/${file}`

export const ghReadFile = opts =&gt; async (...args) =&gt; {
    const file = (opts.prefix || &#x27;&#x27;) + args[0]
    const params = {
        method: &quot;GET&quot;,
        headers: {
            &quot;Authorization&quot;: `token ${opts.token}`,
            &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
        },
    }
    const resp = await fetch(getEndpoint(opts,file), params)
    // resp.origJson = resp.json
    resp.text = async () =&gt; {
        console.log(&quot;ghReadFile text()...&quot;)
        const data = await resp.json()
        console.log(&quot;ghReadFile data&quot;, data)
        const content = b64DecodeUnicode(data.content)
        console.log(&quot;ghReadFile decoded&quot;, content)
        return content
    }
    console.log(&quot;ghReadFile&quot;, file, resp)
    return resp
}

export const ghWriteFile = (opts) =&gt; async (...args) =&gt; {
   
    const file = (opts.prefix || &#x27;&#x27;) + args[0]
    const content = args[1].toString()
    console.log(&quot;ghWriteFile&quot;, file)
    const endpoint = getEndpoint(opts, file)
    const resp1 = await fetch(endpoint)
    const json1 = await resp1.json()
    console.log(endpoint, json1.sha ? &quot;Exists, updating...&quot;:&quot;Dosn&#x27;t exist, creating...&quot;)
    const params = {
        method: &quot;PUT&quot;,
        headers: {
            &quot;Authorization&quot;: `token ${opts.token}`,
            &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
        },
        body: JSON.stringify({
            sha: json1.sha,
            message: opts.commitMessage || `Updated ${file}`,
            content: b64EncodeUnicode(content)
        })
    }
    console.log(&quot;ghWriteFile params&quot;, params)
    let resp2;
    try {
      resp2 = await fetch(endpoint, params)
    } catch(err) {
      console.log(&quot;ghWriteFile PUT failed&quot;, err)
    }
    return resp2 &amp;&amp; resp2.status
}

export const ghDeleteFile = opts =&gt; async (...args) =&gt; {
    const file = (opts.prefix || &#x27;&#x27;) + args[0]
    console.log(&quot;ghDeleteFile&quot;, file)
    const endpoint = getEndpoint(opts, file)
    const resp1 = await fetch(endpoint)
    const json1 = await resp1.json()
    console.log(endpoint, json1.sha ? &quot;Exists, deleting...&quot;:&quot;Dosn&#x27;t exist&quot;)
    const params = {
        method: &quot;DELETE&quot;,
        headers: {
            &quot;Authorization&quot;: `token ${opts.token}`,
            &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
        },
        body: JSON.stringify({
            sha: json1.sha,
            message: opts.commitMessage || `Deleted ${file}`,
        })
    }
    console.log(&quot;ghDeleteFile params&quot;, params)
    let resp2;
    try {
      resp2 = await fetch(endpoint, params)
      const json = await resp2.json()
      console.log(&quot;ghDeleteFile DELETE response&quot;, resp2, json)
    } catch(err) {
      console.log(&quot;ghDeleteFile DELETE failed&quot;, err.message, err)
    }
    return resp2 &amp;&amp; resp2.status
}

</code></pre></codecell></div></cell><cell startpos="16:1-302" endpos="18:4-357" class="code"><div class="cell-content"><codecell class="lang-js local"><span class="meta"><span class="lang">js</span></span><pre><code class="js">localStorage.setItem(&#x27;ghToken&#x27;, &#x27;YOUR_TOKEN&#x27;)
</code></pre></codecell></div></cell></section></div></div><div id="backlinks"><h4>Backlinks (2)</h4><ol><li><a title=".lit" href="/index.html">.lit</a></li><li><a title=".lit" href="/index.html">.lit</a></li></ol></div><script src="//cdn.jsdelivr.net/npm/eruda"></script><script>eruda.init();</script><script src="/web.bundle.js"></script></body></html>